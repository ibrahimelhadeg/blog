<!DOCTYPE html>
<html lang=EN>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62489908-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-62489908-6');
    </script>

    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="In this post, I am going to walk through why the Passport-JWT authentication strategy is a simple, secure solution for small teams and startups implementing a Node/Express + Angular web app.  To under">
<meta name="keywords" content="Session Based Authentication,JWT Authentication">
<meta property="og:type" content="article">
<meta property="og:title" content="A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)">
<meta property="og:url" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/index.html">
<meta property="og:site_name" content="Zach Gollwitzer">
<meta property="og:description" content="In this post, I am going to walk through why the Passport-JWT authentication strategy is a simple, secure solution for small teams and startups implementing a Node/Express + Angular web app.  To under">
<meta property="og:locale" content="EN">
<meta property="og:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/auth-types.PNG">
<meta property="og:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/jwt-postman.PNG">
<meta property="og:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/ang-app-1.gif">
<meta property="og:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/ang-app-2.gif">
<meta property="og:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/ang-app-3.gif">
<meta property="og:updated_time" content="2019-12-12T03:24:37.613Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)">
<meta name="twitter:description" content="In this post, I am going to walk through why the Passport-JWT authentication strategy is a simple, secure solution for small teams and startups implementing a Node/Express + Angular web app.  To under">
<meta name="twitter:image" content="http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/auth-types.PNG">
    
    
        
          
              <link rel="shortcut icon" href="/blog/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)</title>
    <!-- styles -->
    <link rel="stylesheet" href="/blog/css/style.css">
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/blog/2019/making-sense-of-public-key-cryptography/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&text=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&is_video=false&description=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)&body=Check out this article: http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&name=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Authentication-Choices"><span class="toc-number">1.</span> <span class="toc-text">Authentication Choices</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Session-Based-Authentication"><span class="toc-number">2.</span> <span class="toc-text">What is Session Based Authentication?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Headers"><span class="toc-number">2.1.</span> <span class="toc-text">HTTP Headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Cookies-Work"><span class="toc-number">2.2.</span> <span class="toc-text">How Cookies Work</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Reality-of-this-Situation"><span class="toc-number">2.3.</span> <span class="toc-text">The Reality of this Situation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sessions"><span class="toc-number">2.4.</span> <span class="toc-text">Sessions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Quick-Refresher-on-Express-Middleware"><span class="toc-number">2.5.</span> <span class="toc-text">Quick Refresher on Express Middleware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Express-Session-Middleware-works"><span class="toc-number">2.6.</span> <span class="toc-text">How Express Session Middleware works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Passport-JS-Local-Strategy-works"><span class="toc-number">2.7.</span> <span class="toc-text">How Passport JS Local Strategy works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conceptual-Overview-of-Session-Based-Authentication"><span class="toc-number">2.8.</span> <span class="toc-text">Conceptual Overview of Session Based Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Based-Authentication-Implementation"><span class="toc-number">2.9.</span> <span class="toc-text">Session Based Authentication Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-JWT-Based-Authentication"><span class="toc-number">3.</span> <span class="toc-text">What is JWT Based Authentication?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Review-and-Preview"><span class="toc-number">3.1.</span> <span class="toc-text">Review and Preview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Components-of-a-JSON-Web-Token-JWT"><span class="toc-number">3.2.</span> <span class="toc-text">Components of a JSON Web Token (JWT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-signature-step-by-step"><span class="toc-number">3.3.</span> <span class="toc-text">Creating the signature step by step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Verifying-the-signature-step-by-step"><span class="toc-number">3.4.</span> <span class="toc-text">Verifying the signature step by step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zoom-Out-The-true-value-of-JWT-signatures"><span class="toc-number">3.5.</span> <span class="toc-text">Zoom Out: The true value of JWT signatures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-do-I-use-the-passport-jwt-Strategy"><span class="toc-number">3.6.</span> <span class="toc-text">How do I use the passport-jwt Strategy??</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intro-to-jsonwebtoken-and-passport-jwt-configuration"><span class="toc-number">3.7.</span> <span class="toc-text">Intro to jsonwebtoken and passport-jwt configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What-about-Angular-How-does-that-handle-JWTs"><span class="toc-number">3.8.</span> <span class="toc-text">What about Angular?  How does that handle JWTs?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-Based-Authentication-Implementation"><span class="toc-number">3.9.</span> <span class="toc-text">JWT Based Authentication Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Zach Gollwitzer</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-12-12T09:21:11.000Z" itemprop="datePublished">2019-12-12</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/blog/tags/JWT-Authentication/">JWT Authentication</a>, <a class="tag-link" href="/blog/tags/Session-Based-Authentication/">Session Based Authentication</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>In this post, I am going to walk through why the <code>Passport-JWT</code> authentication strategy is a simple, secure solution for small teams and startups implementing a Node/Express + Angular web app. </p>
<p>To understand why a JWT authentication flow is the best choice for this situation, I am going to take you through what authentication options are available to you, how they work, and how to implement them (with the exclusion of OAuth as this is out of scope).</p>
<p>Since this post is long and detailed, if you are already familiar with a topic discussed, just skip it.  Likewise, if you are just looking for instructions on how to implemement a particular authentication method, you can jump to those sections below: </p>
<ul>
<li><a href="#Session-Based-Authentication-Implementation">Session Based Authentication Implementation</a></li>
<li><a href="#JWT-Based-Authentication-Implementation">JWT Based Authentication Implementation</a></li>
</ul>
<p>Also, I created sample applications utilizing both authentication methods in the following repositories:</p>
<ul>
<li><a href="https://github.com/zachgoll/express-session-authentication-starter" target="_blank" rel="noopener">Session Based Auth Repo</a></li>
<li><a href="https://github.com/zachgoll/express-jwt-authentication-starter" target="_blank" rel="noopener">JWT Auth Repo</a></li>
</ul>
<h2 id="Authentication-Choices"><a href="#Authentication-Choices" class="headerlink" title="Authentication Choices"></a>Authentication Choices</h2><img src="/blog/2019/choosing-authentication-strategy/auth-types.PNG">
<p>Above is a high level overview of the main authentication choices available to developers today.  Here is a quick overview of each: </p>
<ul>
<li>Session Based Authentication - Utilizes browser Cookies along with backend “Sessions” to manage logged-in and logged-out users.</li>
<li>JWT Authentication - A stateless authentication method where a JSON Web token (JWT) is stored in the browser (usually <code>localStorage</code>).  This JWT has assertions about a user and can only be decoded using a secret that is stored on the server.</li>
<li>OAuth and OpenID Connect Authentication - A modern authentication method where an application uses “claims” generated from other applications to authenticate its own users.  In other words, this is federated authentication where an existing service (like Google) handles the authentication and storage of users while your application leverages this flow to authenticate users.</li>
</ul>
<p>One note I’ll make–Oauth can become confusing really quickly, and therefore is not fully explored in this post.  Not only is it unecessary for a small team/startup getting an application off the ground, but it is also highly variable depending on which service you are using (i.e. Google, Facebook, Github, etc.).</p>
<p>Finally, you might notice that OAuth is listed as “As a service” and “In house”.  This is a specific note made to highlight the fact that there is actually a company called “OAuth” that implements the OAuth protocol… As a service.  You can implement the OAuth protocol without using OAuth the company’s service!</p>
<h2 id="What-is-Session-Based-Authentication"><a href="#What-is-Session-Based-Authentication" class="headerlink" title="What is Session Based Authentication?"></a>What is Session Based Authentication?</h2><p>If we were to create a lineage for these authentication methods, session based authentication would be the oldest of them all, but certainly not obsolete.  This method of authentication is “server-side”, which means our Express application and database work together to keep the current authentication status of each user that visits our application.</p>
<p>To understand the basic tenets of session-based-authentication, you need to understand a few concepts: </p>
<ul>
<li>Basic HTTP Header Protocol</li>
<li>What a cookie is</li>
<li>What a session is</li>
<li>How the session (server) and cookie (browser) interact to authenticate a user</li>
</ul>
<h3 id="HTTP-Headers"><a href="#HTTP-Headers" class="headerlink" title="HTTP Headers"></a>HTTP Headers</h3><p>There are many ways to make an HTTP request in a browser.  An HTTP client could be a web application, IoT device, command line (curl), or a multitude of others.  Each of these clients connect to the internet and make HTTP requests which either fetch data (GET), or modify data (POST, PUT, DELETE, etc.).</p>
<p>For explanation purposes, let’s assume that: </p>
<p>Server = <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a><br>Client = random guy in a coffee shop working on a laptop</p>
<p>When that random person from the coffee shop types <code>www.google.com</code> into their Google Chrome browser, this request will be sent with “HTTP Headers”.  These HTTP Headers are key:value pairs that provide additional data to the browser to help complete the request.  This request will have two types of headers:</p>
<ol>
<li>General Headers</li>
<li>Request Headers</li>
</ol>
<p>To make this interactive, open Google Chrome, open your developer tools (right click, “Inspect”), and click on the “Network” tab.  Now, type <code>www.google.com</code> into your address bar, and watch as the Network tab loads several resources from the server.  You should see several columns like Name, Status, Type, Initiator, Size, Time, and Waterfall.  Find the request that has “document” as the “Type” value and click on it.  You should see all the headers for this request and response interaction.</p>
<p>The request that you (as the client) made will have General and Request headers resembling (but not exact) the following: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">General Headers</span><br><span class="line">  Request URL: https://www.google.com/</span><br><span class="line">  Request Method: GET</span><br><span class="line">  Status Code: 200</span><br><span class="line"></span><br><span class="line">Request Headers</span><br><span class="line">  Accept: text/html</span><br><span class="line">  Accept-Language: en-US</span><br><span class="line">  Connection: keep-alive</span><br></pre></td></tr></table></figure>
<p>When you typed <code>www.google.com</code> into your address bar and pressed enter, your HTTP request was sent with these headers (and probably a few others).  Although these headers are relatively self explanatory, I want to walk through a few to get a better idea of what HTTP Headers are used for.  Feel free to look up any you don’t know on <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" target="_blank" rel="noopener">MDN</a>.</p>
<p>The <code>General</code> headers can be a mix of both request and response data.  Clearly, the <code>Request URL</code> and <code>Request Method</code> are part of the request object and they tell the Google Chrome browser where to route your request.  The <code>Status Code</code> is clearly part of the response because it indicates that your GET request was successfull and the webpage at <code>www.google.com</code> loaded okay.</p>
<p>The <code>Request Headers</code> only contain headers included with the request object itself.  You can think of request headers as “instructions for the server”.  In this case, my request tells the Google server the following: </p>
<ul>
<li>Hey Google Server, please send me HTML or text data.  I’m either incapable or not interested in reading anything else right now!</li>
<li>Hey Google Server, please only send me English words</li>
<li>Hey Google Server, please don’t close my connection with you after the request is over</li>
</ul>
<p>There are many more request headers that you can set, but these are just a few common ones that you will probably see on all HTTP requests.</p>
<p>So when you searched for <code>www.google.com</code>, you sent your request and the headers to the Google Server (for simplicity, we will just assume it is one big server).  The Google Server accepted your request, read through the “instructions” (headers), and created a <em>response</em>.  The response was comprised of: </p>
<ul>
<li>HTML data (what you see in your Browser)</li>
<li>HTTP Headers</li>
</ul>
<p>As you might have guessed, the “Response Headers” were those set by the Google Server.  Here are a few that you might see: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Response Headers</span><br><span class="line">  Content-Length: 41485</span><br><span class="line">  Content-Type: text/html; charset=UTF-8</span><br><span class="line">  Set-Cookie: made_up_cookie_name=some value; expires=Thu, 28-Dec-2020 20:44:50 GMT;</span><br></pre></td></tr></table></figure>
<p>These response headers are fairly straightforward with the exception of the <code>Set-Cookie</code> header.</p>
<p>I included the <code>Set-Cookie</code> header because it is exactly what we need to understand in order to learn what Session based Authentication is all about (and will help us understand other auth methods later in this post).</p>
<h3 id="How-Cookies-Work"><a href="#How-Cookies-Work" class="headerlink" title="How Cookies Work"></a>How Cookies Work</h3><p>Without Cookies in the browser, we have a problem.</p>
<p>If we have a protected webpage that we want our users to login to access, without cookies, those users would have to login every time they refresh the page!  That is because the HTTP protocol is by default “stateless”.</p>
<p>Cookies introduce the concept of “persistent state” and allow the browser to “remember” something that the server told it previously.</p>
<p>The Google Server can tell my Google Chrome Browser to give me access to a protected page, but the second I refresh the page, my browser will “forget” this and make me authenticate again.</p>
<p>This is where Cookies come in, and explains what the <code>Set-Cookie</code> header is aiming to do.  In the above request where we typed in <code>www.google.com</code> into our browser and pressed enter, our client sent a request with some headers, and the Google Server responsed with a response and some headers.  One of these response headers was <code>Set-Cookie: made_up_cookie_name=some value; expires=Thu, 28-Dec-2020 20:44:50 GMT;</code>.  Here’s how this interaction works: </p>
<p>Server: “Hey client!  I want you to set a cookie called <code>made_up_cookie_name</code> and set it equal to <code>some value</code>.</p>
<p>Client: “Hey server, I will set this on the <code>Cookie</code> header of all my requests to this domain until Dec 28, 2020!”</p>
<p>We can verify that this actually happened in Google Chrome Developer Tools.  Go to “Application”-&gt;”Storage” and click “Cookies”.  Now click on the site that you are currently visiting and you will see all the cookies that have been set for this site.  In our made-up example, you might see something like: </p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Expires / Max-Age</th>
</tr>
</thead>
<tbody>
<tr>
<td>made_up_cookie_name</td>
<td>some value</td>
<td>2020-12-28T20:44:50.674Z</td>
</tr>
</tbody>
</table>
<p>This cookie will now be set to the <code>Cookie</code> <strong>Request Header</strong> on all requests made to <code>www.google.com</code> until the expiry date set on the cookie.</p>
<p>As you might conclude, this could be extremely useful for authentication if we set some sort of “auth” cookie.  An overly simplified process of how this might work would be: </p>
<ol>
<li>Random person from the coffee shop types <code>www.example-site.com/login/</code> into the browser</li>
<li>Random person from the coffee shop fills out a form on this page with a username and password</li>
<li>Random person’s Google Chrome Browser submits a POST request with the login data (username, password) to the server running <code>www.example-site.com</code>.</li>
<li>The server running <code>www.example-site.com</code> receives the login info, checks the database for that login info, validates the login info, and if successful, creates a response that has the header <code>Set-Cookie: user_is_authenticated=true; expires=Thu, 1-Jan-2020 20:00:00 GMT</code>.</li>
<li>The random person’s Google Chrome browser receives this response and sets a browser cookie:</li>
</ol>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Expires / Max-Age</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_is_authenticated</td>
<td>true</td>
<td>2020-12-28T20:44:50.674Z</td>
</tr>
</tbody>
</table>
<ol start="6">
<li>The random person now visits <code>www.example-site.com/protected-route/</code></li>
<li>The random person’s browser creates an HTTP request with the header <code>Cookie: user_is_authenticated=true; expires=Thu, 1-Jan-2020 20:00:00 GMT</code> attached to the request.</li>
<li>The server receives this request, sees that there is a cookie on the request, “remembers” that it had authenticated this user just a few seconds ago, and allows the user to visit the page.</li>
</ol>
<h3 id="The-Reality-of-this-Situation"><a href="#The-Reality-of-this-Situation" class="headerlink" title="The Reality of this Situation"></a>The Reality of this Situation</h3><p>Obviously, what I have just described would be a highly insecure way to authenticate a user.  In reality, the server would create some sort of hash from the password the user provided, and validate that hash with some crypto library on the server.</p>
<p>That said, the high-level concept is valid, and it allows us to understand the value of cookies when talking about authentication.</p>
<p>Keep this example in mind as we move through the remainder of this post.</p>
<h3 id="Sessions"><a href="#Sessions" class="headerlink" title="Sessions"></a>Sessions</h3><p>Sessions and cookies are actually quite similar, and can get confused because they can actually be used <em>together</em> quite seamlessly.  The <em>main difference</em> between the two is the <strong>location</strong> of their storage.  </p>
<p>In other words, a Cookie is <em>set</em> by the server, but stored in the Browser.  If the server wants to use this Cookie to store data about a user’s “state”, it would have to come up with an elaborate scheme to constantly keep track of what the cookie in the browser looks like.  It might go something like this: </p>
<ul>
<li>Server: Hey browser, I just authenticated this user, so you should store a cookie to remind me (<code>Set-Cookie: user_auth=true; expires=Thu, 1-Jan-2020 20:00:00 GMT</code>) next time you request something from me</li>
<li>Browser: Thanks, server!  I will attach this cookie to my <code>Cookie</code> request header</li>
<li>Browser: Hey server, can I see the contents at <code>www.domain.com/protected</code>?  Here is the cookie you sent me on the last request.</li>
<li>Server: Sure, I can do that.  Here is the page data.  I have also included another <code>Set-Cookie</code> header (<code>Set-Cookie: marketing_page_visit_count=1; user_ip=192.1.234.21</code>) because the company who owns me likes to track how many people have visited this specific page and from which computer for marketing purposes.</li>
<li>Browser: Okay, I’ll add that cookie to my <code>Cookie</code> request header</li>
<li>Browser: Hey Server, can you send me the contents at <code>www.domain.com/protected/special-offer</code>?  Here are all the cookies that you have set on me so far. (<code>Cookie: user_auth=true; expires=Thu, 1-Jan-2020 20:00:00 GMT; marketing_page_visit_count=1; user_ip=192.1.234.21</code>)</li>
</ul>
<p>As you can see, the more pages the browser visits, the more cookies the Server sets, and the more cookies the Browser must attach in each request Header.</p>
<p>The Server might have some function that parses through all the cookies attached to a request and perform certain actions based on the presence or absence of a specific cookie.  To me, this naturally begs the question… Why doesn’t the server just keep a record of this information in a database and use a single “session ID” to identify events that a user is taking?</p>
<p>This is exactly what a session is for.  As I mentioned, the main difference between a cookie and a session is <em>where</em> they are stored.  A session is stored in some Data Store (fancy term for a database) while a Cookie is stored in the Browser.  Since the session is stored on the server, it can store sensitive information.  Storing sensitive information in a cookie would be highly insecure.</p>
<p>Now where this all gets a bit confusing is when we talk about using cookies and session <em>together</em>.</p>
<p>Since Cookies are the method in which the client and server communicate metadata (among other HTTP Headers), a session must still utilize cookies.  The easiest way to see this interaction is by actually building out a simple authentication application in Node + Express + MongoDB.  I will assume that you have a basic understanding of building apps in Express, but I will try to explain each piece as we go.</p>
<p>Setup a basic app: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir session-auth-app</span><br><span class="line">cd session-auth-app</span><br><span class="line">npm init -y</span><br><span class="line">npm install --save express mongoose dotenv connect-mongo express-session passport passport-local</span><br></pre></td></tr></table></figure>
<p>Here is <code>app.js</code>.  Read through the comments to learn more about what is going on before continuing.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Package documentation - https://www.npmjs.com/package/connect-mongo</span></span><br><span class="line"><span class="keyword">const</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- GENERAL SETUP ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Gives us access to variables set in the .env file via `process.env.VARIABLE_NAME` syntax</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Express application</span></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware that allows Express to parse through both JSON and x-www-form-urlencoded request bodies</span></span><br><span class="line"><span class="comment">// These are the same as `bodyParser` - you probably would see bodyParser put here in most apps</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- DATABASE ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Connect to MongoDB Server using the connection string in the `.env` file.  To implement this, place the following</span></span><br><span class="line"><span class="comment"> * string into the `.env` file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * DB_STRING=mongodb://&lt;user&gt;:&lt;password&gt;@localhost:27017/database_name</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">const</span> connection = mongoose.createConnection(process.env.DB_STRING);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates simple schema for a User.  The hash and salt are derived from the user's given password when they register</span></span><br><span class="line"><span class="keyword">const</span> UserSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    hash: <span class="built_in">String</span>,</span><br><span class="line">    salt: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Defines the model that we will use in the app</span></span><br><span class="line">mongoose.model(<span class="string">'User'</span>, UserSchema);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- SESSION SETUP ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MongoStore is used to store session data.  We will learn more about this in the post.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Note that the `connection` used for the MongoStore is the same connection that we are using above</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> sessionStore = <span class="keyword">new</span> MongoStore(&#123; <span class="attr">mongooseConnection</span>: connection, <span class="attr">collection</span>: <span class="string">'sessions'</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * See the documentation for all possible options - https://www.npmjs.com/package/express-session</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * As a brief overview (we will add more later): </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * secret: This is a random string that will be used to "authenticate" the session.  In a production environment,</span></span><br><span class="line"><span class="comment"> * you would want to set this to a long, randomly generated string</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * resave: when set to true, this will force the session to save even if nothing changed.  If you don't set this, </span></span><br><span class="line"><span class="comment"> * the app will still run but you will get a warning in the terminal</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * saveUninitialized: Similar to resave, when set true, this forces the session to be saved even if it is unitialized</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: process.env.SECRET,</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">    store: sessionStore </span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- ROUTES ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// When you visit http://localhost:3000/login, you will see "Login Page"</span></span><br><span class="line">app.get(<span class="string">'/login'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Login Page&lt;/h1&gt;'</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/login'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// When you visit http://localhost:3000/register, you will see "Register Page"</span></span><br><span class="line">app.get(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Register Page&lt;/h1&gt;'</span>);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- SERVER ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Server listens on http://localhost:3000</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>The first thing we need to do is understand how the <code>express-session</code> module is working within this application.  This is a “middleware”, which is a fancy way of saying that it is a function that modifies something in our application.  </p>
<h3 id="Quick-Refresher-on-Express-Middleware"><a href="#Quick-Refresher-on-Express-Middleware" class="headerlink" title="Quick Refresher on Express Middleware"></a>Quick Refresher on Express Middleware</h3><p>Let’s say we had the following code: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom middleware</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMiddleware1</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.newProperty = <span class="string">'my custom property'</span>;</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Another custom middleware</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMiddleware2</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.newProperty = <span class="string">'updated value'</span>;</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">`&lt;h1&gt;Custom Property Value: <span class="subst">$&#123;req.newProperty&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server listens on http://localhost:3000</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>As you can see, this is an extremely simple Express application that defines two middlewares and has a single route that you can visit in your browser at <code>http://localhost:3000</code>.  If you started this application and visited that route, it would say “Custom Property Value: undefined” because defining middleware functions alone is not enough.</p>
<p>We need to tell the Express application to actually use these middlewares.  We can do this in a few ways.  First, we can do it within a route.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, myMiddleware1, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">`&lt;h1&gt;Custom Property Value: <span class="subst">$&#123;req.newProperty&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If you add the first middleware function as an argument to the route, you will now see “Custom Property Value: my custom property” show up in the browser.  What really happened here: </p>
<ol>
<li>The application was initialized</li>
<li>A user visited <code>http://localhost:3000/</code> in the browser, which triggered the <code>app.get()</code> function.</li>
<li>The Express application first checked to see if there was any “global” middleware installed on the router, but it didn’t find any.</li>
<li>The Express application looked at the <code>app.get()</code> function and noticed that there was a middleware function installed before the callback.  The application ran the middleware and passed the middleware the <code>req</code> object, <code>res</code> object, and the <code>next()</code> callback.</li>
<li>The <code>myMiddleware1</code> middleware first set <code>req.newProperty</code>, and then called <code>next()</code>, which tells the Express application “Go to the next middleware”.  If the middleware did not call <code>next()</code>, the browser would get “stuck” and not return anything.</li>
<li>The Express app did not see any more middleware, so it continued with the request and sent the result.</li>
</ol>
<p>This is just one way to use middleware, and it is exactly how the <code>passport.authenticate()</code> function (more on this later, so keep in mind) works.</p>
<p>Another way we can use middleware is by setting it “globally”.  Take a look at our app after this change:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom middleware</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMiddleware1</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.newProperty = <span class="string">'my custom property'</span>;</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Another custom middleware</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMiddleware2</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.newProperty = <span class="string">'updated value'</span>;</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(myMiddleware2);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, myMiddleware1, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// Sends "Custom Property Value: my custom property</span></span><br><span class="line">    res.send(<span class="string">`&lt;h1&gt;Custom Property Value: <span class="subst">$&#123;req.newProperty&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server listens on http://localhost:3000</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>With this app structure, you will notice that visiting <code>http://localhost:3000/</code> in the browser <em>still</em> returns the same value as before.  This is because the <code>app.use(myMiddleware2)</code> middleware is happening <em>before</em> the <code>app.get(&#39;/&#39;, myMiddleware1)</code>.  If we removed the middleware from the route, you will see the updated value in the browser. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.use(myMiddleware2);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// Sends "Custom Property Value: updated value</span></span><br><span class="line">    res.send(<span class="string">`&lt;h1&gt;Custom Property Value: <span class="subst">$&#123;req.newProperty&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We could also get this result by placing the second middleware after the first within the route.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, myMiddleware1, myMiddleware2, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// Sends "Custom Property Value: updated value</span></span><br><span class="line">    res.send(<span class="string">`&lt;h1&gt;Custom Property Value: <span class="subst">$&#123;req.newProperty&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Although this is a quick and high-level overview of middleware in Express, it will help us understand what is going on with the <code>express-session</code> middleware.</p>
<h3 id="How-Express-Session-Middleware-works"><a href="#How-Express-Session-Middleware-works" class="headerlink" title="How Express Session Middleware works"></a>How Express Session Middleware works</h3><p>As I mentioned before, the <code>express-session</code> module gives us middleware that we can use in our application.  The middleware is defined in this line: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Again, here is the documentation for this - https://www.npmjs.com/package/express-session</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: process.env.SECRET,</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">    store: sessionStore </span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>Here is a brief overview of what the Express Session Middleware is doing:</p>
<ol>
<li>When a route is loaded, the middleware checks to see if there is a session established in the Session Store (MongoDB database in our case since we are using the <code>connect-mongo</code> custom Session Store).  </li>
<li>If there is a session, the middleware validates it cryptographically and then tells the Browser whether the session is valid or not.  If it is valid, the Browser automatically attaches the <code>connect.sid</code> Cookie to the HTTP request.</li>
<li>If there is no session, the middleware creates a new session, takes a cryptographic hash of the session, and stores that value in a Cookie called <code>connect.sid</code>.  It then attaches the <code>Set-Cookie</code> HTTP header to the <code>res</code> object with the hashed value (<code>Set-Cookie: connect.sid=hashed value</code>).</li>
</ol>
<p>You might be wondering why this is useful at all, and how all this actually works.</p>
<p>If you remember from the quick refresher on Express Middlewares, I said that a middleware has the ability to alter the <code>req</code> and <code>res</code> objects that are passed from one middleware to the next until it reaches the end of the HTTP request.  Just like we set a custom property on the <code>req</code> object, we could also set something much more complex like a <code>session</code> object that has properties, methods, etc.</p>
<p>That is exactly what the <code>express-session</code> middleware does.  When a new session is created, the following properties are added to the <code>req</code> object: </p>
<ul>
<li><code>req.sessionID</code> - A randomly generated UUID.  You can define a custom function to generate this ID by setting the <code>genid</code> option.  If you do not set this option, the default is to use the <code>uid-safe</code> <a href="https://www.npmjs.com/package/uid-safe" target="_blank" rel="noopener">module</a>.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(session(&#123;</span><br><span class="line">  genid: <span class="function"><span class="keyword">function</span> (<span class="params">req</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Put your UUID implementation here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<ul>
<li><code>req.session</code> - The Session object.  This contains information about the session and is available for setting custom properties to use.  For example, maybe you want to track how many times a particular page is loaded in a single session: </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/tracking-route'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (req.session.viewCount) &#123;</span><br><span class="line">    req.session.viewCount = req.session.viewCount + <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    req.session.viewCount = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.send(<span class="string">"&lt;p&gt;View count is: "</span> + req.session.viewCount + <span class="string">"&lt;/p&gt;"</span>);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>req.session.cookie</code> - The Cookie object.  This defines the behaviour of the cookie that stores the hashed session ID in the browser.  Remember, once the cookie has been set, the browser will attach it to every HTTP request automatically until it expires.</li>
</ul>
<h3 id="How-Passport-JS-Local-Strategy-works"><a href="#How-Passport-JS-Local-Strategy-works" class="headerlink" title="How Passport JS Local Strategy works"></a>How Passport JS Local Strategy works</h3><p>There is one last thing that we need to learn in order to fully understand Session Based Authentication–Passport JS.</p>
<p>Passport JS has over 500 authentication “Strategies” that can be used within a Node/Express app.  Many of these strategies are highly specific (i.e. <code>passport-amazon</code> allows you to authenticate into your app via Amazon credentials), but they all work similar within your Express app.</p>
<p>In my opinion, the Passport module could use some work in the department of documentation.  Not only does Passport consist of two modules (Passport base + Specific Strategy), but it is also a middleware, which as we saw is a bit confusing in its own right.  To add to the confusion, the strategy that we are going to walk through (<code>passport-local</code>) is a middleware that modifies an object created by another middleware (<code>express-session</code>).  Since the Passport documentation has little to say around how this all works, I will attempt to explain it to the best of my ability in this post.</p>
<p>Let’s first walk through the setup of the module.</p>
<p>If you have been following along with this tutorial, you already have the modules needed.  If not, you will need to install Passport and a Strategy to your project.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save passport passport-local</span><br></pre></td></tr></table></figure>
<p>Once you have done that, you will need to implement Passport within your application.  Below, I have added all the pieces you need for the <code>passport-local</code> strategy.  I have removed comments to simplify.  Take a quick read through the code and then we will walk through all of the <code>// NEW</code> code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// NEW</span></span><br><span class="line"><span class="keyword">const</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);</span><br><span class="line"><span class="keyword">const</span> LocalStrategy = <span class="built_in">require</span>(<span class="string">'passport-local'</span>).Strategy;</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> connection = mongoose.createConnection(process.env.DB_STRING);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    hash: <span class="built_in">String</span>,</span><br><span class="line">    salt: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">mongoose.model(<span class="string">'User'</span>, UserSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sessionStore = <span class="keyword">new</span> MongoStore(&#123; <span class="attr">mongooseConnection</span>: connection, <span class="attr">collection</span>: <span class="string">'sessions'</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: process.env.SECRET,</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">    store: sessionStore </span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// NEW</span></span><br><span class="line"><span class="comment">// START PASSPORT</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validPassword</span>(<span class="params">password, hash, salt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hashVerify = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">return</span> hash === hashVerify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genPassword</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> salt = crypto.randomBytes(<span class="number">32</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">var</span> genHash = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      salt: salt,</span><br><span class="line">      hash: genHash</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">passport.use(<span class="keyword">new</span> LocalStrategy(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">username, password, cb</span>) </span>&#123;</span><br><span class="line">        User.findOne(&#123; <span class="attr">username</span>: username &#125;)</span><br><span class="line">            .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!user) &#123; <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>) &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Function defined at bottom of app.js</span></span><br><span class="line">                <span class="keyword">const</span> isValid = validPassword(password, user.hash, user.salt);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, user);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;   </span><br><span class="line">                cb(err);</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="literal">null</span>, user.id);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, cb</span>) </span>&#123;</span><br><span class="line">    User.findById(id, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> cb(err); &#125;</span><br><span class="line">        cb(<span class="literal">null</span>, user);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- </span></span><br><span class="line"><span class="comment">// END PASSPORT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/login'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Login Page&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/login'</span>, (req, res, next) =&gt; &#123;&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Register Page&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>Yes, I know there is a lot to take in here.  Let’s start with the easy parts–the helper functions.  In the code above, I have two helper functions that will assist in creating and validating a password.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The plain text password</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; hash - The hash stored in the database</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; salt - The salt stored in the database</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function uses the crypto library to decrypt the hash using the salt and then compares</span></span><br><span class="line"><span class="comment"> * the decrypted hash/salt with the password that the user provided at login</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validPassword</span>(<span class="params">password, hash, salt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hashVerify = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">return</span> hash === hashVerify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The password string that the user inputs to the password field in the register form</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function takes a plain text password and creates a salt and hash out of it.  Instead of storing the plaintext</span></span><br><span class="line"><span class="comment"> * password in the database, the salt and hash are stored for security</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * ALTERNATIVE: It would also be acceptable to just use a hashing algorithm to make a hash of the plain text password.</span></span><br><span class="line"><span class="comment"> * You would then store the hashed password in the database and then re-hash it to verify later (similar to what we do here)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genPassword</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> salt = crypto.randomBytes(<span class="number">32</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">var</span> genHash = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      salt: salt,</span><br><span class="line">      hash: genHash</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In addition to the comments, I’ll note that these functions require the NodeJS built-in <code>crypto</code> library.  Some would argue a better crypto library, but unless your application requires a high degree of security, this library is plenty sufficient!</p>
<p>Next up, let’s take a look at the <code>passport.use()</code> method.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This function is called when the `passport.authenticate()` method is called.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * If a user is found an validated, a callback is called (`cb(null, user)`) with the user</span></span><br><span class="line"><span class="comment"> * object.  The user object is then serialized with `passport.serializeUser()` and added to the </span></span><br><span class="line"><span class="comment"> * `req.session.passport` object. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">passport.use(<span class="keyword">new</span> LocalStrategy(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">username, password, cb</span>) </span>&#123;</span><br><span class="line">        User.findOne(&#123; <span class="attr">username</span>: username &#125;)</span><br><span class="line">            .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!user) &#123; <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>) &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Function defined at bottom of app.js</span></span><br><span class="line">                <span class="keyword">const</span> isValid = validPassword(password, user.hash, user.salt);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, user);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;   </span><br><span class="line">                cb(err);</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>I know the above function is quite a lot to look at, so let’s explore some of its key components.  First, I’ll mention that with <strong>all</strong> Passport JS authentication strategies (not just the local strategy we are using), you will need to supply it with a callback that will be executed when you call the <code>passport.authenticate()</code> method.  For example, you might have a login route in your app: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>, &#123; <span class="attr">failureRedirect</span>: <span class="string">'/login'</span> &#125;), (err, req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'You are logged in!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Your user will type in their username and password via a login form, which will create an HTTP POST request to the <code>/login</code> route.  Let’s say your post request contained the following data: </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"email"</span>: <span class="string">"sample@email.com"</span>,</span><br><span class="line">  <span class="attr">"pw"</span>: <span class="string">"sample password"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This WILL NOT WORK.  The reason?  Because the <code>passport.use()</code> method <em>expects</em> your POST request to have the following fields: </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"username"</span>: <span class="string">"sample@email.com"</span>,</span><br><span class="line">  <span class="attr">"password"</span>: <span class="string">"sample password"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It looks for <code>username</code> and <code>password</code> field.  If you wanted the first json request body to work, you would need to supply the <code>passport.use()</code> function with field definitions:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">passport.use(</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    usernameField: <span class="string">'email'</span>,</span><br><span class="line">    passwordField: <span class="string">'pw'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">email, password, callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implement your callback function here</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>By defining the <code>usernameField</code> and <code>passwordField</code>, you can specify a custom POST request body object.</p>
<p>That aside, let’s return to the POST request at the <code>/login</code> route:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>, &#123; <span class="attr">failureRedirect</span>: <span class="string">'/login'</span> &#125;), (err, req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'You are logged in!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>When the user submits his/her login credentials, the <code>passport.authenticate()</code> method (used as middleware here) will execute the callback that you have defined and supply it with the <code>username</code> and <code>password</code> from the POST request body.  The <code>passport.authenticate()</code> method takes two parameters–the name of the strategy, and options.  The default strategy name here is <code>local</code>, but you could change this like so: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Supply a name string as the first argument to the passport.use() function</span></span><br><span class="line">passport.use(<span class="string">'custom-name'</span>, <span class="keyword">new</span> Strategy());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the same name as above</span></span><br><span class="line">app.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'custom-name'</span>, &#123; <span class="attr">failureRedirect</span>: <span class="string">'/login'</span> &#125;), (err, req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'You are logged in!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The way I have used the <code>passport.authenticate()</code> strategy will first execute the callback function that we defined within <code>new LocalStrategy()</code>, and if the authentication is successful, it will call the <code>next()</code> function, and we will enter the route.  If authentication was not successful (invalid username or password), the app will redirect to the <code>/login</code> route again.</p>
<p>Now that we understand how it is used, let’s return to the callback function that we defined earlier and that <code>passport.authenticate()</code> is using.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tells Passport to use this strategy for the passport.authenticate() method</span></span><br><span class="line">passport.use(<span class="keyword">new</span> LocalStrategy(</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here is the function that is supplied with the username and password field from the login POST request</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">username, password, cb</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Search the MongoDB database for the user with the supplied username</span></span><br><span class="line">        User.findOne(&#123; <span class="attr">username</span>: username &#125;)</span><br><span class="line">            .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * The callback function expects two values: </span></span><br><span class="line"><span class="comment">                 * </span></span><br><span class="line"><span class="comment">                 * 1. Err</span></span><br><span class="line"><span class="comment">                 * 2. User </span></span><br><span class="line"><span class="comment">                 * </span></span><br><span class="line"><span class="comment">                 * If we don't find a user in the database, that doesn't mean there is an application error,</span></span><br><span class="line"><span class="comment">                 * so we use `null` for the error value, and `false` for the user value</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (!user) &#123; <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>) &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Since the function hasn't returned, we know that we have a valid `user` object.  We then</span></span><br><span class="line"><span class="comment">                 * validate the `user` object `hash` and `salt` fields with the supplied password using our </span></span><br><span class="line"><span class="comment">                 * utility function.  If they match, the `isValid` variable equals True.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">const</span> isValid = validPassword(password, user.hash, user.salt);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">                    <span class="comment">// Since we have a valid user, we want to return no err and the user object</span></span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, user);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Since we have an invalid user, we want to return no err and no user</span></span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;   </span><br><span class="line">                <span class="comment">// This is an application error, so we need to populate the callback `err` field with it</span></span><br><span class="line">                cb(err);</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>I have commented the above in great detail, so be sure to read through before moving on.</p>
<p>As you may notice, the callback function is database agnostic and validation agnostic.  In other words, we don’t need to use MongoDB nor do we need to validate our passwords in the same way.  PassportJS leaves this up to us!  This can be confusing, but is also extremely powerful and is why PassportJS has such widespread adoption.</p>
<p>Next, you’ll see two related functions: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="literal">null</span>, user.id);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, cb</span>) </span>&#123;</span><br><span class="line">    User.findById(id, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> cb(err); &#125;</span><br><span class="line">        cb(<span class="literal">null</span>, user);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Personally, I found these two functions to be the most confusing because there is not a lot of documentation around them.  We will further explore what these functions are doing when we talk about how PassportJS and Express Session middleware interact, but in short, these two functions are responsible for “serializing” and “deserializing” users to and from the current session object.</p>
<p>Instead of storing the entire <code>user</code> object in the session, we only need to store the database ID for the user.  When we need to get more information about the user in the current session, we can use the deserialize function to look the user up in the database using the ID that was stored in the session.  Again, we will make more sense of this soon.</p>
<p>Finally, with the Passport implementation, you will see two more lines of code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br></pre></td></tr></table></figure>
<p>If you remember from earlier in the post on how middleware works, by calling <code>app.use()</code>, we are telling Express to execute the functions within the parentheses <strong>in order</strong> on <strong>every request</strong>.</p>
<p>In other words, for every HTTP request our Express app makes, it will execute <code>passport.initialize()</code> and <code>passport.session()</code>.</p>
<p>Something seem weird here??</p>
<p>If <code>app.use()</code> <strong>executes</strong> the function contained within, then the above syntax is like saying: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">passport.initialize()();</span><br><span class="line">passport.session()();</span><br></pre></td></tr></table></figure>
<p>The reason this works is because these two functions actually return another function!  Kind of like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Passport.prototype.initialize = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Does something </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// This is what is called by `app.use()`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is not necessary to know to use Passport, but definitely clears up some confusion if you were wondering about that syntax.</p>
<p>Anyways… </p>
<p>These two middleware functions are necessary for integrating PassportJS with <code>express-session</code> middleware.  That is why these two functions <strong>must come AFTER</strong> the <code>app.use(session({}))</code> middleware!  Just like <code>passport.serializeUser()</code> and <code>passport.deserializeUser()</code>, these middlewares will make much more sense shortly.</p>
<h3 id="Conceptual-Overview-of-Session-Based-Authentication"><a href="#Conceptual-Overview-of-Session-Based-Authentication" class="headerlink" title="Conceptual Overview of Session Based Authentication"></a>Conceptual Overview of Session Based Authentication</h3><p>Now that we understand HTTP Headers, Cookies, Middleware, Express Session middleware, and Passport JS middleware, it is finally time to learn how to use these to authenticate users into our application.  I want to first use this section to review and explain the conceptual flow, and then dive into the implementation in the next section.</p>
<p>Here is a basic flow of our app:</p>
<ol>
<li>Express app starts and listens on <code>http://www.expressapp.com</code> (just assume this is true for the sake of the example).</li>
<li>A user visits <code>http://www.expressapp.com/login</code> in the browser</li>
<li>The <code>express-session</code> middleware realizes that there is a user connecting to the Express server.  It checks the <code>Cookie</code> HTTP header on the <code>req</code> object.  Since this user is visiting for the first time, there is no value in the <code>Cookie</code> header.  Because there is no <code>Cookie</code> value, the Express server returns the <code>/login</code> HTML and calls the <code>Set-Cookie</code> HTTP header.  The <code>Set-Cookie</code> value is the cookie string generated by <code>express-session</code> middleware according to the options set by the developer (assume in this case the maxAge value is 10 days). </li>
<li>The user realizes that he doesn’t want to login right now, but instead, wants to go for a walk.  He closes his browser.</li>
<li>The user returns from his walk, opens the browser, and returns to <code>http://www.expressapp.com/login</code> again.</li>
<li>Again, the <code>express-session</code> middleware runs on the GET request, checks the <code>Cookie</code> HTTP header, but this time, finds a value!  This is because the user had previously created a session earlier that day.  Since the <code>maxAge</code> option was set to 10 days on the <code>express-session</code> middleware, closing the browser does not destroy the cookie.</li>
<li>The <code>express-session</code> middleware now takes the <code>connect.sid</code> value from the <code>Cookie</code> HTTP header, looks it up in the <code>MongoStore</code> (fancy way to say that it looks up the id in the database in the <code>sessions</code> collection), and finds it.  Since the session exists, the <code>express-session</code> middleware does not do anything, and both the <code>Cookie</code> HTTP header value and the <code>MongoStore</code> database entry in the <code>sessions</code> collection stays the same.</li>
<li>Now, the user types in his username and password and presses the “Login” button.</li>
<li>By pressing the “Login” button, the user sends a POST request to the <code>/login</code> route, which uses the <code>passport.authenticate()</code> middleware.  </li>
<li>On every request so far, the <code>passport.initialize()</code> and <code>passport.session()</code> middlewares have been running.  On each request, these middlewares are checking the <code>req.session</code> object (created by the <code>express-session</code> middleware) for a property called <code>passport.user</code> (i.e. <code>req.session.passport.user</code>).  Since the <code>passport.authenticate()</code> method had not been called yet, the <code>req.session</code> object did not have a <code>passport</code> property.  Now that the <code>passport.authenticate()</code> method has been called via the POST request to <code>/login</code>, Passport will execute our user-defined authentication callback using the username and password our user typed in and submitted.</li>
<li>We will assume that the user was already registered in the database and typed in the correct credentials.  The Passport callback validates the user successfully.</li>
<li>The <code>passport.authenticate()</code> method now returns the <code>user</code> object that was validated.  In addition, it attaches the <code>req.session.passport</code> property to the <code>req.session</code> object, serializes the user via <code>passport.serializeUser()</code>, and attaches the serialized user (i.e. the ID of the user) to the <code>req.session.passport.user</code> property.  Finally, it attaches the full user object to <code>req.user</code>.</li>
<li>The user turns off his computer and goes for another walk because our application is boring.</li>
<li>The user turns on his computer the next day and visits a <strong>protected route</strong> on our application.</li>
<li>The <code>express-session</code> middleware checks the <code>Cookie</code> HTTP header on <code>req</code>, finds the session from yesterday (still valid since our <code>maxAge</code> was set to 10 days), looks it up in <code>MongoStore</code>, finds it, and does nothing to the <code>Cookie</code> since the session is still valid.  The middleware re-initializes the <code>req.session</code> object and sets to the value returned from <code>MongoStore</code>.</li>
<li>The <code>passport.initialize()</code> middleware checks the <code>req.session.passport</code> property and sees that there is still a <code>user</code> value there.  The <code>passport.session()</code> middleware uses the <code>user</code> property found on <code>req.session.passport.user</code> to re-initialize the <code>req.user</code> object to equal the user attached to the session via the <code>passport.deserializeUser()</code> function.</li>
<li>The protected route looks to see if <code>req.session.passport.user</code> exists.  Since the Passport middleware just re-initialized it, it does, and the protected route allows the user access.</li>
<li>The user leaves his computer for 2 months.</li>
<li>The user comes back and visits the same protected route (hint: the session has expired!)</li>
<li>The <code>express-session</code> middleware runs, realizes that the value of the <code>Cookie</code> HTTP header has an <strong>expired</strong> cookie value, and replaces the <code>Cookie</code> value with a new Session via the <code>Set-Cookie</code> HTTP header attached to the <code>res</code> object.</li>
<li>The <code>passport.initialize()</code> and <code>passport.session()</code> middlewares run, but this time, since <code>express-session</code> middleware had to create a new session, there is no longer a <code>req.session.passport</code> object!</li>
<li>Since the user did not log in and is trying to access a protected route, the route will check if <code>req.session.passport.user</code> exists.  Since it doesn’t, access is denied!</li>
<li>Once the user logs in again and triggers the <code>passport.authenticate()</code> middleware, the <code>req.session.passport</code> object will be re-established, and the user will again be able to visit protected routes.</li>
</ol>
<p>Phewwww….</p>
<p>Got all that?</p>
<h3 id="Session-Based-Authentication-Implementation"><a href="#Session-Based-Authentication-Implementation" class="headerlink" title="Session Based Authentication Implementation"></a>Session Based Authentication Implementation</h3><p>The hard part is over.</p>
<p>Putting everything together, below is your full functional Session Based authentication Express app.  Below is the app contained within a single file, but I have also refactored this application closer to what you would use in the real world in <a href="https://github.com/zachgoll/express-session-authentication-starter" target="_blank" rel="noopener">this repository</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> LocalStrategy = <span class="built_in">require</span>(<span class="string">'passport-local'</span>).Strategy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Package documentation - https://www.npmjs.com/package/connect-mongo</span></span><br><span class="line"><span class="keyword">const</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- GENERAL SETUP ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Gives us access to variables set in the .env file via `process.env.VARIABLE_NAME` syntax</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Express application</span></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- DATABASE ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Connect to MongoDB Server using the connection string in the `.env` file.  To implement this, place the following</span></span><br><span class="line"><span class="comment"> * string into the `.env` file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * DB_STRING=mongodb://&lt;user&gt;:&lt;password&gt;@localhost:27017/database_name</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> conn = <span class="string">'mongodb://devuser:123@localhost:27017/general_dev'</span>;</span><br><span class="line"><span class="comment">//process.env.DB_STRING</span></span><br><span class="line"><span class="keyword">const</span> connection = mongoose.createConnection(conn, &#123;</span><br><span class="line">    useNewUrlParser: <span class="literal">true</span>,</span><br><span class="line">    useUnifiedTopology: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates simple schema for a User.  The hash and salt are derived from the user's given password when they register</span></span><br><span class="line"><span class="keyword">const</span> UserSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    hash: <span class="built_in">String</span>,</span><br><span class="line">    salt: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = connection.model(<span class="string">'User'</span>, UserSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This function is called when the `passport.authenticate()` method is called.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * If a user is found an validated, a callback is called (`cb(null, user)`) with the user</span></span><br><span class="line"><span class="comment"> * object.  The user object is then serialized with `passport.serializeUser()` and added to the </span></span><br><span class="line"><span class="comment"> * `req.session.passport` object. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">passport.use(<span class="keyword">new</span> LocalStrategy(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">username, password, cb</span>) </span>&#123;</span><br><span class="line">        User.findOne(&#123; <span class="attr">username</span>: username &#125;)</span><br><span class="line">            .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!user) &#123; <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>) &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Function defined at bottom of app.js</span></span><br><span class="line">                <span class="keyword">const</span> isValid = validPassword(password, user.hash, user.salt);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, user);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;   </span><br><span class="line">                cb(err);</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;));</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This function is used in conjunction with the `passport.authenticate()` method.  See comments in</span></span><br><span class="line"><span class="comment"> * `passport.use()` above ^^ for explanation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="literal">null</span>, user.id);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This function is used in conjunction with the `app.use(passport.session())` middleware defined below.</span></span><br><span class="line"><span class="comment"> * Scroll down and read the comments in the PASSPORT AUTHENTICATION section to learn how this works.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * In summary, this method is "set" on the passport object and is passed the user ID stored in the `req.session.passport`</span></span><br><span class="line"><span class="comment"> * object later on.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, cb</span>) </span>&#123;</span><br><span class="line">    User.findById(id, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> cb(err); &#125;</span><br><span class="line">        cb(<span class="literal">null</span>, user);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- SESSION SETUP ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MongoStore is used to store session data.  We will learn more about this in the post.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Note that the `connection` used for the MongoStore is the same connection that we are using above</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> sessionStore = <span class="keyword">new</span> MongoStore(&#123; <span class="attr">mongooseConnection</span>: connection, <span class="attr">collection</span>: <span class="string">'sessions'</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * See the documentation for all possible options - https://www.npmjs.com/package/express-session</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * As a brief overview (we will add more later): </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * secret: This is a random string that will be used to "authenticate" the session.  In a production environment,</span></span><br><span class="line"><span class="comment"> * you would want to set this to a long, randomly generated string</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * resave: when set to true, this will force the session to save even if nothing changed.  If you don't set this, </span></span><br><span class="line"><span class="comment"> * the app will still run but you will get a warning in the terminal</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * saveUninitialized: Similar to resave, when set true, this forces the session to be saved even if it is unitialized</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * store: Sets the MemoryStore to the MongoStore setup earlier in the code.  This makes it so every new session will be </span></span><br><span class="line"><span class="comment"> * saved in a MongoDB database in a "sessions" table and used to lookup sessions</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * cookie: The cookie object has several options, but the most important is the `maxAge` property.  If this is not set, </span></span><br><span class="line"><span class="comment"> * the cookie will expire when you close the browser.  Note that different browsers behave slightly differently with this</span></span><br><span class="line"><span class="comment"> * behaviour (for example, closing Chrome doesn't always wipe out the cookie since Chrome can be configured to run in the</span></span><br><span class="line"><span class="comment"> * background and "remember" your last browsing session)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    <span class="comment">//secret: process.env.SECRET,</span></span><br><span class="line">    secret: <span class="string">'some secret'</span>,</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">    store: sessionStore,</span><br><span class="line">    cookie: &#123;</span><br><span class="line">        maxAge: <span class="number">1000</span> * <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- PASSPORT AUTHENTICATION ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Notice that these middlewares are initialized after the `express-session` middleware.  This is because</span></span><br><span class="line"><span class="comment"> * Passport relies on the `express-session` middleware and must have access to the `req.session` object.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * passport.initialize() - This creates middleware that runs before every HTTP request.  It works in two steps: </span></span><br><span class="line"><span class="comment"> *      1. Checks to see if the current session has a `req.session.passport` object on it.  This object will be</span></span><br><span class="line"><span class="comment"> *          </span></span><br><span class="line"><span class="comment"> *          &#123; user: '&lt;Mongo DB user ID&gt;' &#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *      2.  If it finds a session with a `req.session.passport` property, it grabs the User ID and saves it to an </span></span><br><span class="line"><span class="comment"> *          internal Passport method for later.</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * passport.session() - This calls the Passport Authenticator using the "Session Strategy".  Here are the basic</span></span><br><span class="line"><span class="comment"> * steps that this method takes:</span></span><br><span class="line"><span class="comment"> *      1.  Takes the MongoDB user ID obtained from the `passport.initialize()` method (run directly before) and passes</span></span><br><span class="line"><span class="comment"> *          it to the `passport.deserializeUser()` function (defined above in this module).  The `passport.deserializeUser()`</span></span><br><span class="line"><span class="comment"> *          function will look up the User by the given ID in the database and return it.</span></span><br><span class="line"><span class="comment"> *      2.  If the `passport.deserializeUser()` returns a user object, this user object is assigned to the `req.user` property</span></span><br><span class="line"><span class="comment"> *          and can be accessed within the route.  If no user is returned, nothing happens and `next()` is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- ROUTES ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">'&lt;h1&gt;Home&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// When you visit http://localhost:3000/login, you will see "Login Page"</span></span><br><span class="line">app.get(<span class="string">'/login'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> form = <span class="string">'&lt;h1&gt;Login Page&lt;/h1&gt;&lt;form method="POST" action="/login"&gt;\</span></span><br><span class="line"><span class="string">    Enter Username:&lt;br&gt;&lt;input type="text" name="username"&gt;\</span></span><br><span class="line"><span class="string">    &lt;br&gt;Enter Password:&lt;br&gt;&lt;input type="password" name="password"&gt;\</span></span><br><span class="line"><span class="string">    &lt;br&gt;&lt;br&gt;&lt;input type="submit" value="Submit"&gt;&lt;/form&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    res.send(form);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Since we are using the passport.authenticate() method, we should be redirected no matter what </span></span><br><span class="line">app.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>, &#123; <span class="attr">failureRedirect</span>: <span class="string">'/login-failure'</span>, <span class="attr">successRedirect</span>: <span class="string">'login-success'</span> &#125;), (err, req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// When you visit http://localhost:3000/register, you will see "Register Page"</span></span><br><span class="line">app.get(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> form = <span class="string">'&lt;h1&gt;Register Page&lt;/h1&gt;&lt;form method="post" action="register"&gt;\</span></span><br><span class="line"><span class="string">                    Enter Username:&lt;br&gt;&lt;input type="text" name="username"&gt;\</span></span><br><span class="line"><span class="string">                    &lt;br&gt;Enter Password:&lt;br&gt;&lt;input type="password" name="password"&gt;\</span></span><br><span class="line"><span class="string">                    &lt;br&gt;&lt;br&gt;&lt;input type="submit" value="Submit"&gt;&lt;/form&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    res.send(form);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> saltHash = genPassword(req.body.password);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> salt = saltHash.salt;</span><br><span class="line">    <span class="keyword">const</span> hash = saltHash.hash;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newUser = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        username: req.body.username,</span><br><span class="line">        hash: hash,</span><br><span class="line">        salt: salt</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    newUser.save()</span><br><span class="line">        .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(user);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    res.redirect(<span class="string">'/login'</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lookup how to authenticate users on routes with Local Strategy</span></span><br><span class="line"><span class="comment"> * Google Search: "How to use Express Passport Local Strategy"</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Also, look up what behaviour express session has without a maxage set</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.get(<span class="string">'/protected-route'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.session);</span><br><span class="line">    <span class="keyword">if</span> (req.isAuthenticated()) &#123;</span><br><span class="line">        res.send(<span class="string">'&lt;h1&gt;You are authenticated&lt;/h1&gt;'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">'&lt;h1&gt;You are not authenticated&lt;/h1&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Visiting this route logs the user out</span></span><br><span class="line">app.get(<span class="string">'/logout'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    req.logout();</span><br><span class="line">    res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/login-success'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.session);</span><br><span class="line">    res.send(<span class="string">'You successfully logged in.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/login-failure'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">'You entered the wrong password.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- SERVER ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Server listens on http://localhost:3000</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- HELPER FUNCTIONS ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The plain text password</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; hash - The hash stored in the database</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; salt - The salt stored in the database</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function uses the crypto library to decrypt the hash using the salt and then compares</span></span><br><span class="line"><span class="comment"> * the decrypted hash/salt with the password that the user provided at login</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validPassword</span>(<span class="params">password, hash, salt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hashVerify = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">return</span> hash === hashVerify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The password string that the user inputs to the password field in the register form</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function takes a plain text password and creates a salt and hash out of it.  Instead of storing the plaintext</span></span><br><span class="line"><span class="comment"> * password in the database, the salt and hash are stored for security</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * ALTERNATIVE: It would also be acceptable to just use a hashing algorithm to make a hash of the plain text password.</span></span><br><span class="line"><span class="comment"> * You would then store the hashed password in the database and then re-hash it to verify later (similar to what we do here)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genPassword</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> salt = crypto.randomBytes(<span class="number">32</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">var</span> genHash = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      salt: salt,</span><br><span class="line">      hash: genHash</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="What-is-JWT-Based-Authentication"><a href="#What-is-JWT-Based-Authentication" class="headerlink" title="What is JWT Based Authentication?"></a>What is JWT Based Authentication?</h2><p>Before I start getting lost in the details, I must mention that if you read all the previous sections, this section will be much much easier!  We have already covered a lot of the topics needed to understand how to use the <code>passport-jwt</code> authentication strategy.</p>
<p>Additionally, as we walk through the basics of JWT authentication, we will start to understand why JWT auth is far better for Angular front-end applications (hint: stateless auth!).</p>
<h3 id="Review-and-Preview"><a href="#Review-and-Preview" class="headerlink" title="Review and Preview"></a>Review and Preview</h3><p>As we transition from talking about session-based authentication to JWT based authentication, it is important to keep our authentication flows clear.  To do a quick review, the basic auth flow of a session-based authentication app is like so:</p>
<ol>
<li>User visits your Express application and signs in using his username and password</li>
<li>The username and password are sent via POST request to the <code>/login</code> route on the Express application server</li>
<li>The Express application server will retrieve the user from the database (a hash and salt are stored on the user profile), take a hash of the password that the user provided a few seconds ago using the salt attached to the database user object, and verify that the hash taken matches the hash stored on the database user object.</li>
<li>If the hashes match, we conclude that the user provided the correct credentials, and our <code>passport-local</code> middleware will attach the user to the current session.</li>
<li>For every new request that the user makes on the front-end, their session Cookie will be attached to the request, which will be subsequently verified by the Passport middleware.  If the Passport middleware verifies the session cookie successfully, the server will return the requested route data, and our authentication flow is complete.</li>
</ol>
<p>What I want you to notice about this flow is the fact that the user only had to type in his username and password <strong>one time</strong>, and for the remainder of the session, he can visit protected routes.  The session cookie is <strong>automatically</strong> attached to all of his requests because this is the default behavior of a web browser and how cookies work!  In addition, each time a request is made, the Passport middleware and Express Session middleware will be making a query to our database to retrieve session information.  In other words, <strong>to authenticate a user, a database is required</strong>.</p>
<p>Now skipping forward, you’ll begin to notice that with JWTs, there is absolutely no database required on <strong>each request</strong> to authenticate users.  Yes, we will need to make one database request to initially authenticate a user and generate a JWT, but after that, the JWT will be attached in the <code>Authorization</code> HTTP header (as opposed to <code>Cookie</code> header), and no database is required.</p>
<p>If this doesn’t make sense, that is okay.  We will cover all of the logic in the remaining sections.</p>
<h3 id="Components-of-a-JSON-Web-Token-JWT"><a href="#Components-of-a-JSON-Web-Token-JWT" class="headerlink" title="Components of a JSON Web Token (JWT)"></a>Components of a JSON Web Token (JWT)</h3><p>At the most basic level, a JSON Web Token (JWT) is just a small piece of data that contains information about a user.  It contains three parts:</p>
<ol>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ol>
<p>Each part is encoded in Base64url format (easier to transport over HTTP protocol than JSON objects).</p>
<p>Here is an example JWT:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OG85AmiExREkrS6tDfTQ2B3WXlrr-wp5AokiRbz3_oB4OxG-W9KcEEbDRcZc0nH3L7LzYptiy1PtAylQGxHTWZXtGz4ht0bAecBgmpdgXMguEIcoqPJ1n3pIWk_dUZegpqx0Lka21H6XxUTxiy8OcaarA8zdnPUnV6AmNP3ecFawIFYdvJB_cm-GvpCSbr8G8y_Mllj8f4x9nBH8pQux89_6gUY618iYv7tuPWBFfEbLxtF2pZS6YC1aSfLQxeNe8djT9YjpvRZA</span><br></pre></td></tr></table></figure>
<p>Notice how there are periods <code>.</code> within this text.  These periods separate the header from the payload from the signature.  Let’s isolate the header:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9</span><br></pre></td></tr></table></figure>
<p>Now, let’s install the NodeJS <code>base64url</code> library and decode this.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save base64url</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># I am running this from Node console</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> base64 = <span class="built_in">require</span>(<span class="string">'base64url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerInBase64UrlFormat = <span class="string">'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decoded = base64.decode(headerInBase64UrlFormat);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(decoded);</span><br></pre></td></tr></table></figure>
<p>If we decode the header as shown above, it will give us the following <strong>JSON</strong> object (hence the name, “JSON” Web Token):</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"alg"</span>:<span class="string">"RS256"</span>,</span><br><span class="line">    <span class="attr">"typ"</span>:<span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We will get to what this means later, but for now, let’s decode the payload and the signature using the same method.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># I am running this from Node console</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> base64 = <span class="built_in">require</span>(<span class="string">'base64url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> JWT_BASE64_URL = <span class="string">'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OG85AmiExREkrS6tDfTQ2B3WXlrr-wp5AokiRbz3_oB4OxG-W9KcEEbDRcZc0nH3L7LzYptiy1PtAylQGxHTWZXtGz4ht0bAecBgmpdgXMguEIcoqPJ1n3pIWk_dUZegpqx0Lka21H6XxUTxiy8OcaarA8zdnPUnV6AmNP3ecFawIFYdvJB_cm-GvpCSbr8G8y_Mllj8f4x9nBH8pQux89_6gUY618iYv7tuPWBFfEbLxtF2pZS6YC1aSfLQxeNe8djT9YjpvRZA'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns an array of strings separated by the period</span></span><br><span class="line"><span class="keyword">const</span> jwtParts = JWT_BASE64_URL.split(<span class="string">'.'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerInBase64UrlFormat = jwtParts[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> payloadInBase64UrlFormat = jwtParts[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">const</span> signatureInBase64UrlFormat = jwtParts[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decodedHeader = base64.decode(headerInBase64UrlFormat);</span><br><span class="line"><span class="keyword">const</span> decodedPayload = base64.decode(payloadInBase64UrlFormat);</span><br><span class="line"><span class="keyword">const</span> decodedSignature = base64.decode(signatureInBase64UrlFormat);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(decodedHeader);</span><br><span class="line"><span class="built_in">console</span>.log(decodedPayload);</span><br><span class="line"><span class="built_in">console</span>.log(decodedSignature);</span><br></pre></td></tr></table></figure>
<p>The result of the above code will be:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Header</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"alg"</span>:<span class="string">"RS256"</span>,</span><br><span class="line">    <span class="attr">"typ"</span>:<span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Payload</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"sub"</span>:<span class="string">"1234567890"</span>,</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"John Doe"</span>,</span><br><span class="line">    <span class="attr">"admin"</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"iat"</span>:<span class="number">1516239022</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Signature</span><br><span class="line">Lots of gibberish like - ��e宿���(�$[����4\e�'</span><br></pre></td></tr></table></figure>
<p>For now, ignore the signature part of the JWT.  The reason it cannot be decoded into a meaningful JSON object is because it is a bit more complex than the header and payload.  We will be exploring this further soon.</p>
<p>Let’s walk through the header and payload.</p>
<p>The header has both an <code>alg</code> and <code>typ</code> property.  These are both in the JWT because they represent “instructions” for interpreting that messy signature.</p>
<p>The payload is the simplest part, and is just information about the user that we are authenticating.</p>
<ul>
<li><code>sub</code> - An abbreviation for “subject”, and usually represents the user ID in the database</li>
<li><code>name</code> - Just some arbitrary metadata about the user</li>
<li><code>admin</code> - Some more arbitrary metadata about the user</li>
<li><code>iat</code> - An abbreviation for “issued at”, and represents when this JWT was issued</li>
</ul>
<p>With JWTs, you might also see the following information in a payload: </p>
<ul>
<li><code>exp</code> - An abbreviation for “expiration time”, which indicates the time at which this JWT expires</li>
<li><code>iss</code> - An abbreviation for “issuer”, which is often used when a central login server is issuing many JWT tokens (also used heavily in the OAuth protocol)</li>
</ul>
<p>You can see all of the “standard claims” for the JWT specification <a href="https://tools.ietf.org/html/rfc7519#section-4.1" target="_blank" rel="noopener">at this link</a>.</p>
<h3 id="Creating-the-signature-step-by-step"><a href="#Creating-the-signature-step-by-step" class="headerlink" title="Creating the signature step by step"></a>Creating the signature step by step</h3><p>Although I told you not to worry about that gibberish we received when we tried to decode the <code>signature</code> portion of the JWT, I’m sure it is still bothersome.  In this section, we will learn how that works, but <strong>first</strong>, you’re going to need to read <a href="/blog/2019/making-sense-of-public-key-cryptography/">this article I wrote which explains how Public Key Cryptography works</a> (should take you 10-20 min depending on how familiar you are with the topic).  Even if you are familiar with the topic, you should skim the article.  This section will make absolutely zero sense if you don’t have a solid understanding of public key cryptography.</p>
<p>Anyways…</p>
<p>The signature of a JWT is actually a combination of the <code>header</code> and the <code>payload</code>.  It is created like so (below is pseudocode):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> This is pseudocode!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copied from the original JWT we are using as an example above</span></span><br><span class="line"><span class="keyword">const</span> base64UrlHeader = <span class="string">'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9'</span>;</span><br><span class="line"><span class="keyword">const</span> base64UrlPayload = <span class="string">'eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We take a one-way hash of the header and payload using the SHA256 hashing</span></span><br><span class="line"><span class="comment">// algorithm.  We know to use this algorithm because it was specified in the </span></span><br><span class="line"><span class="comment">// JWT header</span></span><br><span class="line"><span class="keyword">const</span> hashedData = sha256hashFunction(base64UrlHeader + <span class="string">'.'</span> + base64UrlPayload);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The issuer (in our case, it will be the Express server) will sign the hashed</span></span><br><span class="line"><span class="comment">// data with its private key</span></span><br><span class="line"><span class="keyword">const</span> encryptedData = encryptFunction(issuer_priv_key, hashedData);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> finalSignature = convertToBase64UrlFunction(encryptedData);</span><br></pre></td></tr></table></figure>
<p>Even though <code>sha256hashFunction</code>, <code>encryptFunction</code>, and <code>convertToBase64UrlFunction</code> are made up pseudocode, hopefully the above example explains the process of creating the signature adequately.</p>
<p>Now, let’s use the NodeJS <code>crypto</code> library to actually implement the above pseudocode.  Below are the public and private keys that I used to generate this example JWT (which we will need to create and decode the signature of the JWT).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv</span><br><span class="line">vkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc</span><br><span class="line">aT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy</span><br><span class="line">tvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0</span><br><span class="line">e+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb</span><br><span class="line">V6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9</span><br><span class="line">MwIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEogIBAAKCAQEAnzyis1ZjfNB0bBgKFMSvvkTtwlvBsaJq7S5wA+kzeVOVpVWw</span><br><span class="line">kWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHcaT92whREFpLv9cj5lTeJSibyr/Mr</span><br><span class="line">m/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIytvHWTxZYEcXLgAXFuUuaS3uF9gEi</span><br><span class="line">NQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0e+lf4s4OxQawWD79J9/5d3Ry0vbV</span><br><span class="line">3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWbV6L11BWkpzGXSW4Hv43qa+GSYOD2</span><br><span class="line">QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9MwIDAQABAoIBACiARq2wkltjtcjs</span><br><span class="line">kFvZ7w1JAORHbEufEO1Eu27zOIlqbgyAcAl7q+/1bip4Z/x1IVES84/yTaM8p0go</span><br><span class="line">amMhvgry/mS8vNi1BN2SAZEnb/7xSxbflb70bX9RHLJqKnp5GZe2jexw+wyXlwaM</span><br><span class="line">+bclUCrh9e1ltH7IvUrRrQnFJfh+is1fRon9Co9Li0GwoN0x0byrrngU8Ak3Y6D9</span><br><span class="line">D8GjQA4Elm94ST3izJv8iCOLSDBmzsPsXfcCUZfmTfZ5DbUDMbMxRnSo3nQeoKGC</span><br><span class="line">0Lj9FkWcfmLcpGlSXTO+Ww1L7EGq+PT3NtRae1FZPwjddQ1/4V905kyQFLamAA5Y</span><br><span class="line">lSpE2wkCgYEAy1OPLQcZt4NQnQzPz2SBJqQN2P5u3vXl+zNVKP8w4eBv0vWuJJF+</span><br><span class="line">hkGNnSxXQrTkvDOIUddSKOzHHgSg4nY6K02ecyT0PPm/UZvtRpWrnBjcEVtHEJNp</span><br><span class="line">bU9pLD5iZ0J9sbzPU/LxPmuAP2Bs8JmTn6aFRspFrP7W0s1Nmk2jsm0CgYEAyH0X</span><br><span class="line">+jpoqxj4efZfkUrg5GbSEhf+dZglf0tTOA5bVg8IYwtmNk/pniLG/zI7c+GlTc9B</span><br><span class="line">BwfMr59EzBq/eFMI7+LgXaVUsM/sS4Ry+yeK6SJx/otIMWtDfqxsLD8CPMCRvecC</span><br><span class="line">2Pip4uSgrl0MOebl9XKp57GoaUWRWRHqwV4Y6h8CgYAZhI4mh4qZtnhKjY4TKDjx</span><br><span class="line">QYufXSdLAi9v3FxmvchDwOgn4L+PRVdMwDNms2bsL0m5uPn104EzM6w1vzz1zwKz</span><br><span class="line">5pTpPI0OjgWN13Tq8+PKvm/4Ga2MjgOgPWQkslulO/oMcXbPwWC3hcRdr9tcQtn9</span><br><span class="line">Imf9n2spL/6EDFId+Hp/7QKBgAqlWdiXsWckdE1Fn91/NGHsc8syKvjjk1onDcw0</span><br><span class="line">NvVi5vcba9oGdElJX3e9mxqUKMrw7msJJv1MX8LWyMQC5L6YNYHDfbPF1q5L4i8j</span><br><span class="line">8mRex97UVokJQRRA452V2vCO6S5ETgpnad36de3MUxHgCOX3qL382Qx9/THVmbma</span><br><span class="line">3YfRAoGAUxL/Eu5yvMK8SAt/dJK6FedngcM3JEFNplmtLYVLWhkIlNRGDwkg3I5K</span><br><span class="line">y18Ae9n7dHVueyslrb6weq7dTkYDi3iOYRW8HRkIQh06wEdbxt0shTzAJvvCQfrB</span><br><span class="line">jg/3747WSsf/zBTcHihTRBdAv6OmdhV4/dD5YBfLAkLrd+mX7iE=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>First up, let’s create both our header and payload.  I will be using the <code>base64url</code> library for this, so make sure you have it installed.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base64 = <span class="built_in">require</span>(<span class="string">'base64url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerObj = &#123;</span><br><span class="line">    alg: <span class="string">'RS256'</span>,</span><br><span class="line">    typ: <span class="string">'JWT'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payloadObj = &#123;</span><br><span class="line">    sub: <span class="string">'1234567890'</span>,</span><br><span class="line">    name: <span class="string">'John Doe'</span>,</span><br><span class="line">    admin: <span class="literal">true</span>,</span><br><span class="line">    iat: <span class="number">1516239022</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerObjString = <span class="built_in">JSON</span>.stringify(headerObj);</span><br><span class="line"><span class="keyword">const</span> payloadObjString = <span class="built_in">JSON</span>.stringify(payloadObj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> base64UrlHeader = base64(headerObjString);</span><br><span class="line"><span class="keyword">const</span> base64UrlPayload = base64(payloadObjString);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(base64UrlHeader); <span class="comment">// eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9</span></span><br><span class="line"><span class="built_in">console</span>.log(base64UrlPayload); <span class="comment">// eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0</span></span><br></pre></td></tr></table></figure>
<p>Boom! You just created the first two parts of the JWT.  Now, let’s add the creation of the signature to this script.  We will need the built in NodeJS <code>crypto</code> library and the private key to do this.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base64 = <span class="built_in">require</span>(<span class="string">'base64url'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> signatureFunction = crypto.createSign(<span class="string">'RSA-SHA256'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerObj = &#123;</span><br><span class="line">    alg: <span class="string">'RS256'</span>,</span><br><span class="line">    typ: <span class="string">'JWT'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payloadObj = &#123;</span><br><span class="line">    sub: <span class="string">'1234567890'</span>,</span><br><span class="line">    name: <span class="string">'John Doe'</span>,</span><br><span class="line">    admin: <span class="literal">true</span>,</span><br><span class="line">    iat: <span class="number">1516239022</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headerObjString = <span class="built_in">JSON</span>.stringify(headerObj);</span><br><span class="line"><span class="keyword">const</span> payloadObjString = <span class="built_in">JSON</span>.stringify(payloadObj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> base64UrlHeader = base64(headerObjString);</span><br><span class="line"><span class="keyword">const</span> base64UrlPayload = base64(payloadObjString);</span><br><span class="line"></span><br><span class="line">signatureFunction.write(base64UrlHeader + <span class="string">'.'</span> + base64UrlPayload);</span><br><span class="line">signatureFunction.end();</span><br><span class="line"></span><br><span class="line"><span class="comment">// The private key without line breaks</span></span><br><span class="line"><span class="keyword">const</span> PRIV_KEY = fs.readFileSync(__dirname + <span class="string">'/id_rsa_priv.pem'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Will sign our data and return Base64 signature (not the same as Base64Url!)</span></span><br><span class="line"><span class="keyword">const</span> signatureBase64 = signatureFunction.sign(PRIV_KEY, <span class="string">'base64'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> signatureBase64Url = base64.fromBase64(signatureBase64);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(signatureBase64Url); <span class="comment">// POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OG85AmiExREkrS6tDfTQ2B3WXlrr-wp5AokiRbz3_oB4OxG-W9KcEEbDRcZc0nH3L7LzYptiy1PtAylQGxHTWZXtGz4ht0bAecBgmpdgXMguEIcoqPJ1n3pIWk_dUZegpqx0Lka21H6XxUTxiy8OcaarA8zdnPUnV6AmNP3ecFawIFYdvJB_cm-GvpCSbr8G8y_Mllj8f4x9nBH8pQux89_6gUY618iYv7tuPWBFfEbLxtF2pZS6YC1aSfLQxeNe8djT9YjpvRZA</span></span><br></pre></td></tr></table></figure>
<p>In the above code, I have repeated the previous script that we ran with the logic for creating the signature appended.  In this code, we first append the header and the payload (base64url encoded) together by a <code>.</code>.  We then write those contents into our signature function, which is the built-in NodeJS crypto library’s <code>RSA-SHA256</code> signature class.  Although it sounds complicated, all this tells us is to</p>
<ol>
<li>Use an RSA, standard 4096 bit Public/Private keypair</li>
<li>For hashing the <code>base64Url(header) + &#39;.&#39; + base64Url(payload)</code>, use the <code>SHA256</code> hashing algorithm.</li>
</ol>
<p>In the JWT header, you will notice that this is indicated by <code>RS256</code>, which is just an abbreviated way of saying <code>RSA-SHA256</code>.</p>
<p>Once we have written the contents into this function, we need to read the private key we will be signing with from a file.  I have stored the private key shown earlier in this post in a file called <code>id_rsa_priv.pem</code>, which is located in the current working directory and stored in <code>.pem</code> format (pretty standard).</p>
<p>Next, I will “sign” the data, which will first hash the data with the <code>SHA256</code> hashing function, and then encrypt the result with the private key.</p>
<p>Finally, since the NodeJS crypto library returns our value in <code>Base64</code> format, we need to use the <code>base64Url</code> library to convert that from Base64-&gt;Base64Url.</p>
<p>Once that’s done, you will have a JWT header, payload, and signature that match our original JWT perfectly!</p>
<h3 id="Verifying-the-signature-step-by-step"><a href="#Verifying-the-signature-step-by-step" class="headerlink" title="Verifying the signature step by step"></a>Verifying the signature step by step</h3><p>In the previous section, we looked at how you would create a JWT signature.  In user authentication, the flow looks like this:</p>
<ol>
<li>Server receives login credentials (username, password)</li>
<li>Server performs some logic to verify that these credentials are valid</li>
<li>If the credentials are valid, the server issues and <em>signs</em> a JWT and returns it to the user</li>
<li>The user uses the issued JWT to authenticate future requests in the browser</li>
</ol>
<p>But what happens when the user makes another request to a protected route of your application or a protected API endpoint?</p>
<p>Your user presents the server with a JWT token, but how does your server interpret that token and decide whether the user is valid?  Below are the basic steps.</p>
<ol>
<li>Server receives a JWT token</li>
<li>Server first checks if the JWT token has an expiry, and if that expiration date has been passed.  If so, the server denies access.</li>
<li>If the JWT is not expired, the server will first convert the <code>header</code> and <code>payload</code> from Base64Url-&gt;JSON format.</li>
<li>Server looks in the <code>header</code> of the JWT to find which hashing function and encryption algorithm it needs to decrypt the signature (we will assume that in this example, the JWT uses <code>RSA-SHA256</code> as the algorithm.</li>
<li>Server uses a <code>SHA256</code> hashing function to hash <code>base64Url(header) + &#39;.&#39; + base64Url(payload)</code>, which leaves the server with a hash value.</li>
<li>Server uses the <code>Public Key</code> stored in its filesystem to decrypt the <code>base64Url(signature)</code> (remember, private key encrypts, public key decrypts).  Since the server is both creating the signatures and verifying them, it should have both the Public and Private key stored in its filesystem.  For larger use cases, it would be common to have these duties separated to entirely separate machines.</li>
<li>Server compares the values from step 5 and step 6.  If they match, this JWT is valid.</li>
<li>If the JWT is valid, the server uses the <code>payload</code> data to get more information about the user and authenticate that user.</li>
</ol>
<p>Using the <strong>same JWT</strong> that we have been using throughout this post, here is how this process looks in code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base64 = <span class="built_in">require</span>(<span class="string">'base64url'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> verifyFunction = crypto.createVerify(<span class="string">'RSA-SHA256'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> JWT = <span class="string">'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OG85AmiExREkrS6tDfTQ2B3WXlrr-wp5AokiRbz3_oB4OxG-W9KcEEbDRcZc0nH3L7LzYptiy1PtAylQGxHTWZXtGz4ht0bAecBgmpdgXMguEIcoqPJ1n3pIWk_dUZegpqx0Lka21H6XxUTxiy8OcaarA8zdnPUnV6AmNP3ecFawIFYdvJB_cm-GvpCSbr8G8y_Mllj8f4x9nBH8pQux89_6gUY618iYv7tuPWBFfEbLxtF2pZS6YC1aSfLQxeNe8djT9YjpvRZA'</span>;</span><br><span class="line"><span class="keyword">const</span> PUB_KEY = fs.readFileSync(__dirname + <span class="string">'/id_rsa_pub.pem'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jwtHeader = JWT.split(<span class="string">'.'</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> jwtPayload = JWT.split(<span class="string">'.'</span>)[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">const</span> jwtSignature = JWT.split(<span class="string">'.'</span>)[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">verifyFunction.write(jwtHeader + <span class="string">'.'</span> + jwtPayload);</span><br><span class="line">verifyFunction.end();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jwtSignatureBase64 = base64.toBase64(jwtSignature);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> signatureIsValid = verifyFunction.verify(PUB_KEY, jwtSignatureBase64, <span class="string">'base64'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(signatureIsValid); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p>There are several items worthy of note in this code.  First, we take the Base64Url encoded JWT and split it into its 3 parts.  We then use the built-in NodeJS <code>createVerify</code> function to create a new <code>Verify</code> class.  Just like the process of creating the signature, we need to pass in the <code>base64url(header) + &#39;.&#39; + base64url(payload)</code> into the stream used by the <code>Verify</code> crypto class.</p>
<p>The next step is critical–you need to convert the <code>jwtSignature</code> from its default encoding Base64Url-&gt;Base64.  You then need to pass the public key, the Base64 version of the signature, and indicate to NodeJS that you are using Base64.  If you do not specify the encoding, it will default to a Buffer and you will always get a false return value.</p>
<p>If all goes well, you should get a true return value, which means this signature is valid!</p>
<h3 id="Zoom-Out-The-true-value-of-JWT-signatures"><a href="#Zoom-Out-The-true-value-of-JWT-signatures" class="headerlink" title="Zoom Out: The true value of JWT signatures"></a>Zoom Out: The true value of JWT signatures</h3><p>If you read the above two sections, you know how to create and verify a JWT signature using the <code>RSA-SHA256</code> JWT algorithm (other algorithms work very similarly, but this algorithm is considered one of the more secure and “production-ready” algorithms).</p>
<p>But what does it all mean?</p>
<p>I know we have gone in all sorts of directions in this post about user authentication, but all of this knowledge comes together here.  If you think about authenticating a user with Cookies and Sessions, you know that in order to do so, your application server must have a database keeping track of the sessions, and this database must be called each time a user wants to visit a protected resource on the server.</p>
<p>With JWT authentication, the only thing needed to verify that a user is authenticated is a public key!!</p>
<p>Once a JWT token has been issued (by either your application server, an authentication server, or even a 3rd party authentication server), that JWT can be stored in the browser securely and can be used to verify any request without using a database at all.  The application server just needs the public key of the issuer!</p>
<p>If you extrapolate this concept and think about the widespread implications of JWT, it becomes clear how powerful it is.  You no longer need a local database.  You can transport authentication all over the web!  </p>
<p>Let’s say I log in to a popular service like Google and I receive a JWT token from Google’s authentication server.  The only thing that is needed to verify the JWT that I am browsing with is the public key that matches the private key Google signed with.  Usually, this public key is <em>publicly</em> available, which means that anyone on the internet can verify my JWT!  If they trust Google and they trust that Google is providing the correct public key, then there is no reason that I cannot just use the JWT issued by Google to authenticate users into <strong>my application</strong>.</p>
<p>I know I said that we wouldn’t be getting into all the OAuth stuff in this post, but this is the essence of delegated authentication (i.e. the OAuth2.0 protocol)!</p>
<h3 id="How-do-I-use-the-passport-jwt-Strategy"><a href="#How-do-I-use-the-passport-jwt-Strategy" class="headerlink" title="How do I use the passport-jwt Strategy??"></a>How do I use the <code>passport-jwt</code> Strategy??</h3><p>Before we get into the implementation of the <code>passport-jwt</code> strategy, I wanted to make a few notes about implementing JWTs in an authentication strategy.  </p>
<p>Unfortunately and fortunately, there are many ways that you can successfully implement JWTs into your application.  Because of this, if you search Google for “how to implement JWT in an Express App”, you’ll get a variety of implementations.  Let’s take a look at our options from most complex to least complex.</p>
<p><strong>Most Complex:</strong>  If we wanted to make this process as complicated (but also as transparent) as possible, we could use the signing and verifying process that we used earlier in this post using the built-in Node <code>crypto</code> library.  This would require us to write a lot of Express middleware, a lot of custom logic, and a lot of error handling, but it could certainly be done.</p>
<p><strong>Somewhat Complex:</strong>  If we wanted to simplify things a little bit, we could do everything on our own, but instead of using the built-in Node <code>crypto</code> library, we could abstract away a lot of complexity and use the popular package <code>jsonwebtoken</code>.  This is not a terrible idea, and there are actually many tutorials online that show you how to implement JWT authentication using just this library.</p>
<p><strong>Simple (if used correctly):</strong>  Last but not least, we could abstract away even more complexity and use the <code>passport-jwt</code> strategy.  Or wait… Don’t we need the <code>passport-local</code> strategy too since we are authenticating with usernames and passwords?  And how do we generate a JWT in the first place?  Clearly we will need the <code>jsonwebtoken</code> library to do this…</p>
<p>And here lies the problem.</p>
<p>The <code>passport-jwt</code> strategy does not have much documentation, and I personally believe that because of this, the questions I just raised create a world of confusion in the development community.  This results in thousands of different implementations of <code>passport-jwt</code> combined with external libraries, custom middlewares, and much more.  This could be considered a good thing, but for someone looking to implement <code>passport-jwt</code> the “correct way”, it can be frustrating.</p>
<p>Like any software package, if you use it correctly, it will add value to your development.  If you use it incorrectly, it could introduce more complexity to your project than if you never used it in the first place.</p>
<p>In this section, I will do my best to explain what the <code>passport-jwt</code> strategy aims to achieve and how we can use it in a way that actually adds <em>value</em> to our codebase rather than <em>complexity</em>.</p>
<p>So let me start by conveying one very important fact about <code>passport-jwt</code>.</p>
<p><strong>The Passport JWT strategy uses the <code>jsonwebtoken</code> library</strong>.</p>
<p>Why is this important??</p>
<p>Remember–JWTs need to first be <em>signed</em> and then <em>verified</em>.  Passport takes care of the <em>verification</em> for us, so we just need to sign our JWTs and send them off to the <code>passport-jwt</code> middleware to be verified.  Since <code>passport-jwt</code> uses the <code>jsonwebtoken</code> library to verify tokens, then we should probably be using the same library to <em>generate</em> the tokens!</p>
<p>In other words, we need to get familiar with the <code>jsonwebtoken</code> library, which begs the question… Why do we even need Passport in the first place??</p>
<p>With the <code>passport-local</code> strategy, Passport was useful to us because it connected seamlessly with <code>express-session</code> and helped manage our user session.  If we wanted to authenticate a user, we use the <code>passport.authenticate()</code> method on the <code>/login</code> POST route.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>, &#123;&#125;), (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// If we make it here, our user has been authenticate and has been attached</span></span><br><span class="line">    <span class="comment">// to the current session</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If we wanted to authenticate a route (after the user had logged in), all we needed to do was this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/protected'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.isAuthenticated()) &#123;</span><br><span class="line">        <span class="comment">// Send the route data </span></span><br><span class="line">        res.status(<span class="number">200</span>).send(<span class="string">'Web page data'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Not authorized</span></span><br><span class="line">        res.status(<span class="number">401</span>).send(<span class="string">'You are not authorized to view this'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We were able to do this (after the user had logged in) because the <code>passport-local</code> middleware stored our user in the Express Session.  To me, this is a bit odd, because you are only using the <code>passport.authenticate()</code> method one time (for login). </p>
<p>Now that we are using JWTs, we need to authenticate <strong>every single request</strong>, and thus, we will be using the <code>passport.authenticate()</code> method a lot more.</p>
<p>The basic flow looks like this: </p>
<ol>
<li>User logs in with username and password</li>
<li>Express server validates the username and password, signs a JWT, and sends that JWT back to the user.</li>
<li>The user will store the JWT in the browser (this is where our Angular app comes in) via <code>localStorage</code>.</li>
<li>For every request, Angular will add the JWT stored in <code>localStorage</code> to the <code>Authorization</code> HTTP Header (similar to how we stored our session in the <code>Cookie</code> header)</li>
<li>For every request, the Express app will run the <code>passport.authenticate()</code> middleware, which will extract the JWT from the <code>Authorization</code> header, verify it with a Public Key, and based on the result, either allow or disallow a user from visiting a route or making an API call.</li>
</ol>
<p>In summary, to authenticate using the <code>passport-jwt</code> strategy, our routes will look like so: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Session is set to false because we are using JWTs, and don't need a session! * If you do not set this to false, the Passport framework will try and </span></span><br><span class="line"><span class="comment"> * implement a session</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.get(<span class="string">'/protected'</span>, passport.authenticate(<span class="string">'jwt'</span>, &#123; <span class="attr">session</span>: <span class="literal">false</span> &#125;), (req, res, next) =&gt; &#123;</span><br><span class="line">    res.status(<span class="number">200</span>).send(<span class="string">'If you get this data, you have been authenticated via JWT!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>All we need to do is configure Passport with our public/private keys, desired JWT algorithm (RSA256 in our case), and a verify function.</p>
<p>Yes, we could implement our own <code>passport.authenticate()</code> middleware, but if we did, we would need to write functions (and error handling… ughhh) to do the following:</p>
<ul>
<li>Parse the HTTP header</li>
<li>Extract the JWT from the HTTP header</li>
<li>Verify the JWT with <code>jsonwebtoken</code></li>
</ul>
<p>I would much rather delegate that work (and error handling) to a trusted framework like Passport!</p>
<h3 id="Intro-to-jsonwebtoken-and-passport-jwt-configuration"><a href="#Intro-to-jsonwebtoken-and-passport-jwt-configuration" class="headerlink" title="Intro to jsonwebtoken and passport-jwt configuration"></a>Intro to <code>jsonwebtoken</code> and <code>passport-jwt</code> configuration</h3><p>This section will highlight the basic methods and setup of both the <code>jsonwebtoken</code> and <code>passport-jwt</code> modules irrespective of our Express app.  The next section will show how these integrate into the Express and Angular applications.</p>
<p>First, let’s see how we could use <code>jsonwebtoken</code> to sign and verify a JWT.  For this, we will use the same JWT that we used to demonstrate how JWTs worked (below).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OG85AmiExREkrS6tDfTQ2B3WXlrr-wp5AokiRbz3_oB4OxG-W9KcEEbDRcZc0nH3L7LzYptiy1PtAylQGxHTWZXtGz4ht0bAecBgmpdgXMguEIcoqPJ1n3pIWk_dUZegpqx0Lka21H6XxUTxiy8OcaarA8zdnPUnV6AmNP3ecFawIFYdvJB_cm-GvpCSbr8G8y_Mllj8f4x9nBH8pQux89_6gUY618iYv7tuPWBFfEbLxtF2pZS6YC1aSfLQxeNe8djT9YjpvRZA</span><br></pre></td></tr></table></figure>
<p>And here is a basic script that demonstrates how we would sign this JWT and verify it.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PUB_KEY = fs.readFileSync(__dirname + <span class="string">'/id_rsa_pub.pem'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"><span class="keyword">const</span> PRIV_KEY = fs.readFileSync(__dirname + <span class="string">'/id_rsa_priv.pem'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="comment">// -------------------  SIGN ----------------------------------</span></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payloadObj = &#123;</span><br><span class="line">    sub: <span class="string">'1234567890'</span>,</span><br><span class="line">    name: <span class="string">'John Doe'</span>,</span><br><span class="line">    admin: <span class="literal">true</span>,</span><br><span class="line">    iat: <span class="number">1516239022</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Couple things here:</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * First, we do not need to pass in the `header` to the function, because the </span></span><br><span class="line"><span class="comment"> * jsonwebtoken module will automatically generate the header based on the algorithm specified</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Second, we can pass in a plain Javascript object because the jsonwebtoken library will automatically</span></span><br><span class="line"><span class="comment"> * pass it into JSON.stringify()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> signedJWT = jwt.sign(payloadObj, PRIV_KEY, &#123; <span class="attr">algorithm</span>: <span class="string">'RS256'</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(signedJWT); <span class="comment">// Should get the same exact token that we had in our example</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="comment">// -------------------  VERIFY --------------------------------</span></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Verify the token we just signed using the public key.  Also validates our algorithm RS256 </span></span><br><span class="line">jwt.verify(signedJWT, PUB_KEY, &#123; <span class="attr">algorithms</span>: [<span class="string">'RS256'</span>] &#125;, (err, payload) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err.name === <span class="string">'TokenExpiredError'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Whoops, your token has expired!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err.name === <span class="string">'JsonWebTokenError'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'That JWT is malformed!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Your JWT was successfully validated!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Both should be the same</span></span><br><span class="line">    <span class="built_in">console</span>.log(payload);</span><br><span class="line">    <span class="built_in">console</span>.log(payloadObj);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>So how does <code>jsonwebtoken</code> and <code>passport-jwt</code> work together?  Let’s take a look at the configuration for Passport below.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> JwtStrategy = <span class="built_in">require</span>(<span class="string">'passport-jwt'</span>).Strategy</span><br><span class="line"><span class="keyword">const</span> ExtractJwt = <span class="built_in">require</span>(<span class="string">'passport-jwt'</span>).ExtractJwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PUB_KEY = fs.readFileSync(__dirname + <span class="string">'/id_rsa_pub.pem'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// At a minimum, you must pass these options (see note after this code snippet for more)</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),</span><br><span class="line">  secretOrKey: PUB_KEY</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The JWT payload is passed into the verify callback</span></span><br><span class="line">passport.use(<span class="keyword">new</span> JwtStrategy(options, <span class="function"><span class="keyword">function</span>(<span class="params">jwt_payload, done</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We will assign the `sub` property on the JWT to the database ID of user</span></span><br><span class="line">    User.findOne(&#123;<span class="attr">id</span>: jwt_payload.sub&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// This flow look familiar?  It is the same as when we implemented</span></span><br><span class="line">        <span class="comment">// the `passport-local` strategy</span></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> done(err, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user) &#123;</span><br><span class="line">            <span class="keyword">return</span> done(<span class="literal">null</span>, user);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p><strong>Note on options:</strong>  The way that options are assigned in the <code>passport-jwt</code> library can be a bit confusing.  You can pass <code>jsonwebtoken</code> options, but they must be passed in a specific way.  Below is an object with ALL possible options you can use for your <code>passport-jwt</code> object.  I left out the <code>secretOrKeyProvider</code> option because it is the alternative to the <code>secretOrKey</code> option, which is more common.  The <code>secretOrKeyProvider</code> is a callback function used to retrieve a asymmetric key from a <code>jwks</code> key provider.  For explanation of any of these options, you can see the <a href="http://www.passportjs.org/packages/passport-jwt/" target="_blank" rel="noopener">passport-jwt docs</a>, <a href="https://tools.ietf.org/html/rfc7519#section-4.1" target="_blank" rel="noopener">this rfc</a> and the <a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener">jsonwebtoken documentation</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> passportJWTOptions = &#123;</span><br><span class="line">    jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),</span><br><span class="line">    secretOrKey: PUB_KEY || secret phrase,</span><br><span class="line">    issuer: <span class="string">'enter issuer here'</span>,</span><br><span class="line">    audience: <span class="string">'enter audience here'</span>,</span><br><span class="line">    algorithms: [<span class="string">'RS256'</span>],</span><br><span class="line">    ignoreExpiration: <span class="literal">false</span>,</span><br><span class="line">    passReqToCallback: <span class="literal">false</span>,</span><br><span class="line">    jsonWebTokenOptions: &#123;</span><br><span class="line">        complete: <span class="literal">false</span>,</span><br><span class="line">        clockTolerance: <span class="string">''</span>,</span><br><span class="line">        maxAge: <span class="string">'2d'</span>, <span class="comment">// 2 days</span></span><br><span class="line">        clockTimestamp: <span class="string">'100'</span>,</span><br><span class="line">        nonce: <span class="string">'string here for OpenID'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above code (before the options) does the following:</p>
<ol>
<li>When a user visits a protected route, they will attach their JWT to the HTTP <code>Authorization</code> header</li>
<li><code>passport-jwt</code> will grab that value and parse it using the <code>ExtractJwt.fromAuthHeaderAsBearerToken()</code> method.</li>
<li><code>passport-jwt</code> will take the extracted JWT along with the options we set and call the <code>jsonwebtoken</code> library’s <code>verify()</code> method.</li>
<li>If the verification is successful, <code>passport-jwt</code> will find the user in the database, attach it to the <code>req</code> object, and allow the user to visit the given resource.</li>
</ol>
<h3 id="What-about-Angular-How-does-that-handle-JWTs"><a href="#What-about-Angular-How-does-that-handle-JWTs" class="headerlink" title="What about Angular?  How does that handle JWTs?"></a>What about Angular?  How does that handle JWTs?</h3><p>If you remember from part 1 of this post, HTTP <code>Cookies</code> are automatically sent with every HTTP request (until they expire) after the <code>Set-Cookie</code> HTTP header has set the value of them.  With JWTs, this is not the case!</p>
<p>We have two options: </p>
<ol>
<li>We can “intercept” each HTTP request from our Angular application and append the <code>Authorization</code> HTTP Header with our JWT token</li>
<li>We can manually add our JWT token to each request</li>
</ol>
<p>Yes, the first option is a little bit of up-front work, but I think we can manage it.</p>
<p>In addition to the problem of the JWT not being added to each request automatically, we also have the problem of Angular routing.  Since Angular runs in the browser and is a Single Page Application, it is not making an HTTP request every time it loads a new view/route.  Unlike a standard Express application where you actually get the HTML from the Express app itself, Angular delivers the HTML all at once, and then the client-side logic determines how the routing works.</p>
<p>Because of this, we are going to need to build an Authentication Service in our Angular application that will keep track of our user’s authentication state.  We will then allow the user to visit protected Angular routes based on this state.</p>
<p>So if we back up for a second, there are really two layers of authentication going on right now.  On one hand, we have the authentication that happens on the Express server, which determines what HTTP requests our user can make.  Since we are using Angular as a front-end, all of the HTTP requests that we make to our Express app will be data retrieval.  On the other hand, we have authentication within our Angular app.  We could just ignore this authentication completely, but what if we had an Angular component view that loaded data from the database?</p>
<p>If the user is logged out on the Express side of things, this component view will try to load data to display, but since the user is not authenticated on the backend, the data request will fail, and our view will look weird since there is no data to display.</p>
<p>A better way to handle this is by synchronizing the two authentication states.  If the user is not authorized to make a particular GET request for data, then we should probably not let them visit the Angular route that displays that data.  They won’t be able to see the data no matter what, but this behaviour creates a much more seamless and friendly user experience.</p>
<p>Below is the code that we will use for our AuthService and Interceptor.  I found this code in <a href="https://blog.angular-university.io/angular-jwt-authentication/" target="_blank" rel="noopener">a blog post at Angular University</a> and thought it was extremely simple and clean, so we will use it here.  For now, don’t worry about how this integrates into the Angular application as I will show that later in the implementation section.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://momentjs.com/</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> moment <span class="keyword">from</span> <span class="string">"moment"</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gives us access to the Angular HTTP client so we can make requests to </span></span><br><span class="line"><span class="comment">     * our Express app</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">constructor</span>(private http: HttpClient) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Passes the username and password that the user typed into the application</span></span><br><span class="line"><span class="comment">     * and sends a POST request to our Express server login route, which will</span></span><br><span class="line"><span class="comment">     * authenticate the credentials and return a JWT token if they are valid</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * The `res` object (has our JWT in it) is passed to the setLocalStorage</span></span><br><span class="line"><span class="comment">     * method below</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * shareReplay() documentation - https://www.learnrxjs.io/operators/multicasting/sharereplay.html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    login(email:string, <span class="attr">password</span>:string ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.http.post&lt;User&gt;(<span class="string">'/users/login'</span>, &#123;email, password&#125;)</span><br><span class="line">            .do(<span class="function"><span class="params">res</span> =&gt;</span> <span class="keyword">this</span>.setLocalStorage) </span><br><span class="line">            .shareReplay();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private setLocalStorage(authResult) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Takes the JWT expiresIn value and add that number of seconds</span></span><br><span class="line">        <span class="comment">// to the current "moment" in time to get an expiry date</span></span><br><span class="line">        <span class="keyword">const</span> expiresAt = moment().add(authResult.expiresIn,<span class="string">'second'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stores our JWT token and its expiry date in localStorage</span></span><br><span class="line">        localStorage.setItem(<span class="string">'id_token'</span>, authResult.idToken);</span><br><span class="line">        localStorage.setItem(<span class="string">"expires_at"</span>, <span class="built_in">JSON</span>.stringify(expiresAt.valueOf()) );</span><br><span class="line">    &#125;          </span><br><span class="line"></span><br><span class="line">    <span class="comment">// By removing the token from localStorage, we have essentially "lost" our</span></span><br><span class="line">    <span class="comment">// JWT in space and will need to re-authenticate with the Express app to get</span></span><br><span class="line">    <span class="comment">// another one.</span></span><br><span class="line">    logout() &#123;</span><br><span class="line">        localStorage.removeItem(<span class="string">"id_token"</span>);</span><br><span class="line">        localStorage.removeItem(<span class="string">"expires_at"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns true as long as the current time is less than the expiry date</span></span><br><span class="line">    public isLoggedIn() &#123;</span><br><span class="line">        <span class="keyword">return</span> moment().isBefore(<span class="keyword">this</span>.getExpiration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isLoggedOut() &#123;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">this</span>.isLoggedIn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getExpiration() &#123;</span><br><span class="line">        <span class="keyword">const</span> expiration = localStorage.getItem(<span class="string">"expires_at"</span>);</span><br><span class="line">        <span class="keyword">const</span> expiresAt = <span class="built_in">JSON</span>.parse(expiration);</span><br><span class="line">        <span class="keyword">return</span> moment(expiresAt);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: We will eventually incorporate this into our app.module.ts so that it</span></span><br><span class="line"><span class="comment">// automatically works on all HTTP requests</span></span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    intercept(req: HttpRequest&lt;any&gt;,</span><br><span class="line">              next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> idToken = localStorage.getItem(<span class="string">"id_token"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (idToken) &#123;</span><br><span class="line">            <span class="keyword">const</span> cloned = req.clone(&#123;</span><br><span class="line">                headers: req.headers.set(<span class="string">"Authorization"</span>,</span><br><span class="line">                    <span class="string">"Bearer "</span> + idToken)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> next.handle(cloned);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> next.handle(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I suggest reading through all the comments to better understand how each service is working.</p>
<p>You can think of the HTTP Interceptor as “middleware” for Angular.  It will take the existing HTTP request, add the <code>Authorization</code> HTTP header with the JWT stored in <code>localStorage</code>, and call the <code>next()</code> “middleware” in the chain.</p>
<p>And that’s it.  We are ready to build this thing.</p>
<h3 id="JWT-Based-Authentication-Implementation"><a href="#JWT-Based-Authentication-Implementation" class="headerlink" title="JWT Based Authentication Implementation"></a>JWT Based Authentication Implementation</h3><p>It is finally time to jump into the actual implementation of JWT Authentication with an Express/Angular application.  Since we have already covered a lot of the ExpressJS basics (middleware, cookies, sessions, etc.), I will not be devoting sections here to them, but I will briefly walk through some of the Angular concepts.  If anything in this application doesn’t make sense, be sure to read the first half of this post.</p>
<p>All of the code below can be found in <a href="https://github.com/zachgoll/express-jwt-authentication-starter.git" target="_blank" rel="noopener">this example repository on Github</a>.</p>
<p><strong>Initial Setup (skim this section)</strong></p>
<p>Let’s first take a very quick glance at the starting code (file names commented at top of each code snippet):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: app.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- GENERAL SETUP ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Gives us access to variables set in the .env file via `process.env.VARIABLE_NAME` syntax</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Express application</span></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configures the database and opens a global connection that can be used in any module with `mongoose.connection`</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./config/database'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Must first load the models</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./models/user'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instead of using body-parser middleware, use the new Express implementation of the same thing</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allows our Angular application to make HTTP requests to Express application</span></span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Where Angular builds to - In the ./angular/angular.json file, you will find this configuration</span></span><br><span class="line"><span class="comment">// at the property: projects.angular.architect.build.options.outputPath</span></span><br><span class="line"><span class="comment">// When you run `ng build`, the output will go to the ./public directory</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- ROUTES ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Imports all of the routes from ./routes/index.js</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'./routes'</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- SERVER ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Server listens on http://localhost:3000</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>The only slightly irregular thing above is the database connection.  Many times, you will see the connection being made from within <code>app.js</code>, but I did this to highlight that the <code>mongoose.connection</code> object is global.  You can configure it in one module and use it freely in another.  By calling <code>require(&#39;./config/database&#39;);</code>, we are creating that global object.  The file that defines the <code>User</code> model for the database is <code>./models/user.js</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./models/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    hash: <span class="built_in">String</span>,</span><br><span class="line">    salt: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">mongoose.model(<span class="string">'User'</span>, UserSchema);</span><br></pre></td></tr></table></figure>
<p>Next, we have the routes.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./routes/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the routes defined in `./users.js` for all activity to http://localhost:3000/users/</span></span><br><span class="line">router.use(<span class="string">'/users'</span>, <span class="built_in">require</span>(<span class="string">'./users'</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./routes/users.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();   </span><br><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">'User'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://localhost:3000/users/login</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://localhost:3000/users/register</span></span><br><span class="line">router.post(<span class="string">'/register'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>Finally, we have an entire Angular app in the <code>angular/</code> directory.  I generated this using the <code>ng new</code> command.  The only tweaks made to this so far are in <code>./angular/angular.json</code>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/angular.json</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"outputPath"</span>: <span class="string">"../public"</span>, <span class="comment">// Line 16</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>In the first file, we need to set the output directory so that the <code>ng build</code> command builds our Angular application to the <code>./public/</code> directory that our Express app serves static content from.</p>
<p><strong>API Routes</strong></p>
<p>Our first step is to write the logic around password validation.  To keep things consistent, I will be using the <em>exact same logic</em> as I did with the Session Based Authentication example in the first half of this post.</p>
<p>Let’s make a folder <code>./lib</code> and place a <code>utils.js</code> file in it.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./lib/util.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -------------- HELPER FUNCTIONS ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The plain text password</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; hash - The hash stored in the database</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; salt - The salt stored in the database</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function uses the crypto library to decrypt the hash using the salt and then compares</span></span><br><span class="line"><span class="comment"> * the decrypted hash/salt with the password that the user provided at login</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validPassword</span>(<span class="params">password, hash, salt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hashVerify = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">return</span> hash === hashVerify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; password - The password string that the user inputs to the password field in the register form</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function takes a plain text password and creates a salt and hash out of it.  Instead of storing the plaintext</span></span><br><span class="line"><span class="comment"> * password in the database, the salt and hash are stored for security</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * ALTERNATIVE: It would also be acceptable to just use a hashing algorithm to make a hash of the plain text password.</span></span><br><span class="line"><span class="comment"> * You would then store the hashed password in the database and then re-hash it to verify later (similar to what we do here)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genPassword</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> salt = crypto.randomBytes(<span class="number">32</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">var</span> genHash = crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">'sha512'</span>).toString(<span class="string">'hex'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      salt: salt,</span><br><span class="line">      hash: genHash</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.validPassword = validPassword;</span><br><span class="line"><span class="built_in">module</span>.exports.genPassword = genPassword;</span><br></pre></td></tr></table></figure>
<p>The above is the same exact module that we used before.  Now, let’s create routes that will allow us to register a user and login.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./routes/users.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();   </span><br><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">'User'</span>);</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">'../lib/utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://localhost:3000/users/login</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/register'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> saltHash = utils.genPassword(req.body.password);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> salt = saltHash.salt;</span><br><span class="line">    <span class="keyword">const</span> hash = saltHash.hash;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newUser = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        username: req.body.username,</span><br><span class="line">        hash: hash,</span><br><span class="line">        salt: salt</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        newUser.save()</span><br><span class="line">            .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">                res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">user</span>: user &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        </span><br><span class="line">        res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: err &#125;);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>Using Postman (or another HTTP request utility), test the route and create a user.  Here is my post request and results:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"username"</span>: <span class="string">"zach"</span>,</span><br><span class="line">	<span class="attr">"password"</span>: <span class="string">"123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"success"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"user"</span>: &#123;</span><br><span class="line">        <span class="attr">"_id"</span>: <span class="string">"5def83773d50a20d27887032"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"zach"</span>,</span><br><span class="line">        <span class="attr">"hash"</span>: <span class="string">"9aa8c8999e4c25880aa0f3b1b1ae6fbcfdfdedb9fd96295e370a4ecb4e9d30f83d5d91e86d840cc5323e7c4ed15097db5c2262ac95c0c11268d9a90a7755c281"</span>,</span><br><span class="line">        <span class="attr">"salt"</span>: <span class="string">"d63bb43fc411a55f0ac6ff8c145c58f70c8c10e18915b5c6d9578b997d637143"</span>,</span><br><span class="line">        <span class="attr">"__v"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We now have a user in the database that we can test our authentication on, but we currently do not have any logic to use for the <code>/login</code> route.  This is where Passport comes in.</p>
<p>Add <code>passport.js</code> to the <code>./config/</code> directory and put the following in it.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./config/passport</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> JwtStrategy = <span class="built_in">require</span>(<span class="string">'passport-jwt'</span>).Strategy</span><br><span class="line"><span class="keyword">const</span> ExtractJwt = <span class="built_in">require</span>(<span class="string">'passport-jwt'</span>).ExtractJwt;</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'mongoose'</span>).model(<span class="string">'User'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Go up one directory, then look for file name</span></span><br><span class="line"><span class="keyword">const</span> pathToKey = path.join(__dirname, <span class="string">'..'</span>, <span class="string">'id_rsa_pub.pem'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The verifying public key</span></span><br><span class="line"><span class="keyword">const</span> PUB_KEY = fs.readFileSync(pathToKey, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// At a minimum, you must pass the `jwtFromRequest` and `secretOrKey` properties</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),</span><br><span class="line">  secretOrKey: PUB_KEY,</span><br><span class="line">  algorithms: [<span class="string">'RS256'</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js will pass the global passport object here, and this function will configure it</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">passport</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// The JWT payload is passed into the verify callback</span></span><br><span class="line">    passport.use(<span class="keyword">new</span> JwtStrategy(options, <span class="function"><span class="keyword">function</span>(<span class="params">jwt_payload, done</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Since we are here, the JWT is valid!</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// We will assign the `sub` property on the JWT to the database ID of user</span></span><br><span class="line">        User.findOne(&#123;<span class="attr">_id</span>: jwt_payload.sub&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// This flow look familiar?  It is the same as when we implemented</span></span><br><span class="line">            <span class="comment">// the `passport-local` strategy</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="keyword">return</span> done(err, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (user) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Since we are here, the JWT is valid and our user is valid, so we are authorized!</span></span><br><span class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, user);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is the function that will run on every route that we use the <code>passport.authenticate()</code> middleware.  Internally, Passport will verify the supplied JWT with the <code>jsonwebtoken</code> verify method.</p>
<p>Next, let’s create a utility function that will generate a JWT for our user, and put it in the <code>utils.js</code> file.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./lib/utils.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsonwebtoken = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; user - The user object.  We need this to set the JWT `sub` payload property to the MongoDB user ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">issueJWT</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _id = user._id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> expiresIn = <span class="string">'1d'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> payload = &#123;</span><br><span class="line">    sub: _id,</span><br><span class="line">    iat: <span class="built_in">Date</span>.now()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> signedToken = jsonwebtoken.sign(payload, PRIV_KEY, &#123; <span class="attr">expiresIn</span>: expiresIn, <span class="attr">algorithm</span>: <span class="string">'RS256'</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    token: <span class="string">"Bearer "</span> + signedToken,</span><br><span class="line">    expires: expiresIn</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, let’s implement the <code>/users/login/</code> route so that if the user logs in successfully, they will receive a JWT token in the response.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./routes/users.js</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();   </span><br><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">'User'</span>);</span><br><span class="line"><span class="keyword">const</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">'../lib/utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Validate an existing user and issue a JWT</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    User.findOne(&#123; <span class="attr">username</span>: req.body.username &#125;)</span><br><span class="line">        .then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">                res.status(<span class="number">401</span>).json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"could not find user"</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Function defined at bottom of app.js</span></span><br><span class="line">            <span class="keyword">const</span> isValid = utils.validPassword(req.body.password, user.hash, user.salt);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> tokenObject = utils.issueJWT(user);</span><br><span class="line"></span><br><span class="line">                res.status(<span class="number">200</span>).json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">token</span>: tokenObject.token, <span class="attr">expiresIn</span>: tokenObject.expires &#125;);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                res.status(<span class="number">401</span>).json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"you entered the wrong password"</span> &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;   </span><br><span class="line">            next(err);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Time to try it out!  In Postman, make send a POST request to <code>/users/login/</code> with the following data (remember, we already created a user):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"username"</span>: <span class="string">"zach"</span>,</span><br><span class="line">	<span class="string">"password"</span>: <span class="string">"123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When you send that request, you should get the following result (your JWT will be different because you are using a different private key to sign it):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"token"</span>: <span class="string">"Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1ZGVmODM3NzNkNTBhMjBkMjc4ODcwMzIiLCJpYXQiOjE1NzYxMTc4NDAxNzIsImV4cCI6MTU3NjExNzkyNjU3Mn0.NAIbpeukGmDOCMG5uuoFBn4GFjT6tQOpztxw7c1qiWHBSG8LQ0Sf1deKoLDOqS5Dk2N9JzXFmdni0-wt7etD94qH_C_rxL745reGMOrtJNy2SffAlAmhcphs4xlbGRjtBoABxHfiL0Hhht2fbGCwf79s5gDlTC9WqWMq8gcXZkLYXnRQZcHCOvgx-yar_c6cNVxFJBU6ah2sK1mUPTR6ReXUWt_A1lu2aOtgUG-9wXVp9h3Lh3LrdHuTqF4oV2vbTSMGCzAs33C1wwjdCGqCj3dkqfMSE43f7SSAy2-m6TgPAPm0QEUV8PiEpS1GlUCsBKVeVYC5hbUyUDS3PaJYQxklIHVNGNqlyj_1IdNaCuquGvyQDDyflZpJKnUPg1WZVgkDa5hVZerrb8hfG_MLC3vzy-rt3cWUlVItmJsT30sUInDRsfAevDX83gEtD2QR4ZkZA8ppb9s7Yi6V2_L7JUz5aBPUYT4YQo0iNj4_jpaZByqdp03GFGbfv4tmk-oeYnJHwgntoBWk_hfE3h5GbCmtfmlTO5A4CWAMu5W5pNanjNsVzogXrUZCfNaY42HC24blpO507-Vo-GwdIpFCMnrgCLa6DAW3XH-ePlRL-cbIv0-QFiSCge2RerWx5d3qlD9yintqmXf1TyzB3X7IM_JbVYqVB0sGAPrFBZqk0q0"</span>,</span><br><span class="line">    <span class="string">"expiresIn"</span>: <span class="string">"1d"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We will now try this out using a brand new route.  In the <code>./routes/users.js</code> file, add the following route:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/protected'</span>, passport.authenticate(<span class="string">'jwt'</span>, &#123; <span class="attr">session</span>: <span class="literal">false</span> &#125;), (req, res, next) =&gt; &#123;</span><br><span class="line">    res.status(<span class="number">200</span>).json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">msg</span>: <span class="string">"You are successfully authenticated to this route!"</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now in Postman, copy the JWT token you received into the <code>Authorization</code> HTTP header.</p>
<img src="/blog/2019/choosing-authentication-strategy/jwt-postman.PNG">
<p>When you send this request, you should get the expected response of “Your JWT is valid”.  If you don’t get this request, check your files with mine stored at <a href="https://github.com/zachgoll/express-jwt-authentication-starter" target="_blank" rel="noopener">this Github repo</a>.</p>
<p>Now that your backend is working correctly, it is time to implement the Angular side of things.  First, generate the following components:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ng generate component register</span><br><span class="line">ng generate component login</span><br><span class="line">ng generate component protected-component</span><br></pre></td></tr></table></figure>
<p>Let’s get these components and the Angular router setup.  Below are the files you will need to update with comments in them explaining some of the logic.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/app.module.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These two modules will help us with Angular forms and submitting data to </span></span><br><span class="line"><span class="comment">// our Express backend</span></span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; <span class="keyword">from</span> <span class="string">'@angular/forms'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This will allow us to navigate between our components</span></span><br><span class="line"><span class="keyword">import</span> &#123; Routes, RouterModule &#125; <span class="keyword">from</span> <span class="string">'@angular/router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These are the four components in our app so far</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">'./login/login.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RegisterComponent &#125; <span class="keyword">from</span> <span class="string">'./register/register.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProtectedComponentComponent &#125; <span class="keyword">from</span> <span class="string">'./protected-component/protected-component.component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define which route will load which component</span></span><br><span class="line"><span class="keyword">const</span> appRoutes: Routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">'login'</span>, <span class="attr">component</span>: LoginComponent &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">'register'</span>, <span class="attr">component</span>: RegisterComponent &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">'protected'</span>, <span class="attr">component</span>: ProtectedComponentComponent &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your standard Angular setup</span></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    LoginComponent,</span><br><span class="line">    RegisterComponent,</span><br><span class="line">    ProtectedComponentComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    RouterModule.forRoot(appRoutes, &#123;<span class="attr">useHash</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">  ],</span><br><span class="line">  providers: [],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- File: ./angular/src/app/app.component.html --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>JWT Authentication<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- By clicking these, the component assigned to each route will load below --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/login"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/register"</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/protected"</span>&gt;</span>Visit Protected Route<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Selected route displays below:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- This will load the current route --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>And now for each component:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- File: ./angular/src/app/login/login.component.html --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> (<span class="attr">ngSubmit</span>)=<span class="string">"onLoginSubmit()"</span> #<span class="attr">loginform</span>=<span class="string">"ngForm"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Enter a username<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">ngModel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Enter a password<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">ngModel</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px;"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/login/login.component.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Component, OnInit, ViewChild &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgForm &#125; <span class="keyword">from</span> <span class="string">'@angular/forms'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-login'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./login.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./login.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will give us access to the form</span></span><br><span class="line">  @ViewChild(<span class="string">'loginform'</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) loginForm: NgForm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When you submit the form, the username and password values will print to the screen (we will replace this later with an HTTP request)</span></span><br><span class="line">  onLoginSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.loginForm.value.username);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.loginForm.value.password);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- File: ./angular/src/app/register/register.component.html --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> (<span class="attr">ngSubmit</span>)=<span class="string">"onRegisterSubmit()"</span> #<span class="attr">registerform</span>=<span class="string">"ngForm"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Enter a username<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">ngModel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Enter a password<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">ngModel</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px;"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/register/register.component.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Component, OnInit, ViewChild &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgForm &#125; <span class="keyword">from</span> <span class="string">'@angular/forms'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-register'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./register.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./register.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  @ViewChild(<span class="string">'registerform'</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) registerForm: NgForm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onRegisterSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.registerForm.value.username);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.registerForm.value.password);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If all goes well, your app should look something like this:</p>
<img src="/blog/2019/choosing-authentication-strategy/ang-app-1.gif">
<p>Now comes the part where we actually implement our JWT authentication.  The first thing we need to wire up is the ability to send POST requests from our login and register routes.</p>
<p>First, we need to add the <code>HttpClientModule</code> to our app.  In <code>./angular/src/app/app.module.ts</code>, add the following import.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpClientModule &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    RouterModule.forRoot(appRoutes, &#123;<span class="attr">useHash</span>: <span class="literal">true</span>&#125;),</span><br><span class="line">    HttpClientModule</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Now, we can use this in our other components.  Update <code>./angular/src/app/register/register.component.ts</code> with the following:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/register/register.component.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Component, OnInit, ViewChild &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgForm &#125; <span class="keyword">from</span> <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient, HttpHeaders &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-register'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./register.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./register.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  @ViewChild(<span class="string">'registerform'</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) registerForm: NgForm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(private http: HttpClient) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Submits a post request to the /users/register route of our Express app</span></span><br><span class="line">  onRegisterSubmit() &#123;</span><br><span class="line">    <span class="keyword">const</span> username = <span class="keyword">this</span>.registerForm.value.username;</span><br><span class="line">    <span class="keyword">const</span> password = <span class="keyword">this</span>.registerForm.value.password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> headers = <span class="keyword">new</span> HttpHeaders(&#123;<span class="string">'Content-type'</span>: <span class="string">'application/json'</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reqObject = &#123;</span><br><span class="line">      username: username,</span><br><span class="line">      password: password</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.http.post(<span class="string">'http://localhost:3000/users/register'</span>, reqObject, &#123; <span class="attr">headers</span>: headers &#125;).subscribe(</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// The response data</span></span><br><span class="line">      (response) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If there is an error</span></span><br><span class="line">      (error) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;,</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// When observable completes</span></span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'done!'</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can now visit the register component and register yourself on the Express application.  Add the same logic to the login component.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, OnInit, ViewChild &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgForm &#125; <span class="keyword">from</span> <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient, HttpHeaders &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-login'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./login.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./login.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  @ViewChild(<span class="string">'loginform'</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) loginForm: NgForm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(private http: HttpClient) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  onLoginSubmit() &#123;</span><br><span class="line">    <span class="keyword">const</span> username = <span class="keyword">this</span>.loginForm.value.username;</span><br><span class="line">    <span class="keyword">const</span> password = <span class="keyword">this</span>.loginForm.value.password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> headers = <span class="keyword">new</span> HttpHeaders(&#123;<span class="string">'Content-type'</span>: <span class="string">'application/json'</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reqObject = &#123;</span><br><span class="line">      username: username,</span><br><span class="line">      password: password</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.http.post(<span class="string">'http://localhost:3000/users/login'</span>, reqObject, &#123; <span class="attr">headers</span>: headers &#125;).subscribe(</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// The response data</span></span><br><span class="line">      (response) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If there is an error</span></span><br><span class="line">      (error) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;,</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// When observable completes</span></span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'done!'</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, let’s add some logic to the protected route.  In this route, we will make a GET request to our <code>/users/protected</code> route, which should return a <code>401 Unauthorized</code> error if our JWT is not valid.  Since we haven’t written the logic to attach the JWT to each request yet, we should get the error.</p>
<p>In the HTML file of the component, add this one line.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./angular/src/app/protected-component/protected-component.html --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- This will print the value of the `message` variable in protected-component.component.ts --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Message: &#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>And in <code>./angular/src/app/protected-component.component.ts</code>, add the logic to handle the HTTP request.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/protected-component.component.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Component, OnInit &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient, HttpHeaders &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-protected-component'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./protected-component.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./protected-component.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtectedComponentComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(private http: HttpClient) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  message: <span class="built_in">String</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute this HTTP request when the route loads</span></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.http.get(<span class="string">'http://localhost:3000/users/protected'</span>).subscribe(</span><br><span class="line">      (response) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (response) &#123;</span><br><span class="line">          <span class="keyword">this</span>.message = <span class="string">'You are authenticated!'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      (error) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.status === <span class="number">401</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.message = <span class="string">'You are not authorized to visit this route.  No data is displayed.'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line"></span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'HTTP request done'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you visit the protected route right now, you should get the unauthorized error.  But wouldn’t it be nice if we were able to successfully get data from this GET request?  Let’s set up our AuthService.  Create the following folder and file, and install the <code>moment</code> module:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ./angular/src/app/services</span><br><span class="line">touch ./angular/src/app/services/auth.service.ts</span><br><span class="line">npm install --save moment</span><br></pre></td></tr></table></figure>
<p>Now add the following code to your service.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/services/auth.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> moment <span class="keyword">from</span> <span class="string">"moment"</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">          </span><br><span class="line">    setLocalStorage(responseObj) &#123;</span><br><span class="line">        <span class="keyword">const</span> expiresAt = moment().add(responseObj.expiresIn);</span><br><span class="line"></span><br><span class="line">        localStorage.setItem(<span class="string">'id_token'</span>, responseObj.token);</span><br><span class="line">        localStorage.setItem(<span class="string">"expires_at"</span>, <span class="built_in">JSON</span>.stringify(expiresAt.valueOf()) );</span><br><span class="line">    &#125;          </span><br><span class="line"></span><br><span class="line">    logout() &#123;</span><br><span class="line">        localStorage.removeItem(<span class="string">"id_token"</span>);</span><br><span class="line">        localStorage.removeItem(<span class="string">"expires_at"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public isLoggedIn() &#123;</span><br><span class="line">        <span class="keyword">return</span> moment().isBefore(<span class="keyword">this</span>.getExpiration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isLoggedOut() &#123;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">this</span>.isLoggedIn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getExpiration() &#123;</span><br><span class="line">        <span class="keyword">const</span> expiration = localStorage.getItem(<span class="string">"expires_at"</span>);</span><br><span class="line">        <span class="keyword">const</span> expiresAt = <span class="built_in">JSON</span>.parse(expiration);</span><br><span class="line">        <span class="keyword">return</span> moment(expiresAt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this service, we have methods that will create, read, update, and destroy JWT information stored in the browser’s <code>localStorage</code> module.  The last thing you need to do is add this service to <code>app.module.ts</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/app.module.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./services/auth.service'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">providers: [</span><br><span class="line">    AuthService</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>We now need to add some functionality to the <code>login.component.ts</code> to set the JWT that we receive after logging in to <code>localStorage</code>.  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ./angular/src/app/login/login.component.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Import auth service</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'../services/auth.service'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add service to module</span></span><br><span class="line"><span class="keyword">constructor</span>(private http: HttpClient, private authService: AuthService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// In post request, when you receive the JWT, use the service to add it to storage</span></span><br><span class="line"><span class="keyword">this</span>.http.post(<span class="string">'http://localhost:3000/users/login'</span>, reqObject, &#123; <span class="attr">headers</span>: headers &#125;).subscribe(</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// The response data</span></span><br><span class="line">  (response) =&gt; &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// If the user authenticates successfully, we need to store the JWT returned in localStorage</span></span><br><span class="line">    <span class="keyword">this</span>.authService.setLocalStorage(response);</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>After adding this, you should be able to login and have the JWT saved to <code>localStorage</code>.</p>
<img src="/blog/2019/choosing-authentication-strategy/ang-app-2.gif">
<p>Now that we are saving the JWT to <code>localStorage</code> after logging in, the only step left is to implement our HTTP interceptor that will retrieve the JWT sitting in <code>localStorage</code> and attach it to the HTTP <code>Authorization</code> header on every request!</p>
<p>Make the following folder and file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ./angular/src/app/interceptors</span><br><span class="line">touch ./angular/src/app/interceptors/auth-interceptor.ts</span><br></pre></td></tr></table></figure>
<p>Add the following to this file:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpRequest, HttpHandler, HttpEvent, HttpInterceptor &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    intercept(req: HttpRequest&lt;any&gt;,</span><br><span class="line">              next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> idToken = localStorage.getItem(<span class="string">"id_token"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (idToken) &#123;</span><br><span class="line">            <span class="keyword">const</span> cloned = req.clone(&#123;</span><br><span class="line">                headers: req.headers.set(<span class="string">"Authorization"</span>, idToken)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> next.handle(cloned);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> next.handle(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And finally, you will need to import it to <code>app.module.ts</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AuthInterceptor &#125; <span class="keyword">from</span> <span class="string">'./interceptors/auth-interceptor'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">providers: [</span><br><span class="line">    AuthService,</span><br><span class="line">    &#123;</span><br><span class="line">      provide: HTTP_INTERCEPTORS,</span><br><span class="line">      useClass: AuthInterceptor,</span><br><span class="line">      multi: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>And with that, all of your HTTP requests should get the <code>Authorization</code> HTTP header populated with a JWT (if it exists in localStorage) on every request!</p>
<img src="/blog/2019/choosing-authentication-strategy/ang-app-3.gif">
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>You now have a skeleton application to work with and implement in whatever way you like!  I recommend adding additional features like an AuthGuard to handle route authentication even further, but what I have shown you here should get you more than started!</p>
<p>If you have any questions or notice any errors in this massive post, please let me know in the comments below.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Authentication-Choices"><span class="toc-number">1.</span> <span class="toc-text">Authentication Choices</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Session-Based-Authentication"><span class="toc-number">2.</span> <span class="toc-text">What is Session Based Authentication?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Headers"><span class="toc-number">2.1.</span> <span class="toc-text">HTTP Headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Cookies-Work"><span class="toc-number">2.2.</span> <span class="toc-text">How Cookies Work</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Reality-of-this-Situation"><span class="toc-number">2.3.</span> <span class="toc-text">The Reality of this Situation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sessions"><span class="toc-number">2.4.</span> <span class="toc-text">Sessions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Quick-Refresher-on-Express-Middleware"><span class="toc-number">2.5.</span> <span class="toc-text">Quick Refresher on Express Middleware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Express-Session-Middleware-works"><span class="toc-number">2.6.</span> <span class="toc-text">How Express Session Middleware works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Passport-JS-Local-Strategy-works"><span class="toc-number">2.7.</span> <span class="toc-text">How Passport JS Local Strategy works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conceptual-Overview-of-Session-Based-Authentication"><span class="toc-number">2.8.</span> <span class="toc-text">Conceptual Overview of Session Based Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Based-Authentication-Implementation"><span class="toc-number">2.9.</span> <span class="toc-text">Session Based Authentication Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-JWT-Based-Authentication"><span class="toc-number">3.</span> <span class="toc-text">What is JWT Based Authentication?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Review-and-Preview"><span class="toc-number">3.1.</span> <span class="toc-text">Review and Preview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Components-of-a-JSON-Web-Token-JWT"><span class="toc-number">3.2.</span> <span class="toc-text">Components of a JSON Web Token (JWT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-signature-step-by-step"><span class="toc-number">3.3.</span> <span class="toc-text">Creating the signature step by step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Verifying-the-signature-step-by-step"><span class="toc-number">3.4.</span> <span class="toc-text">Verifying the signature step by step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zoom-Out-The-true-value-of-JWT-signatures"><span class="toc-number">3.5.</span> <span class="toc-text">Zoom Out: The true value of JWT signatures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-do-I-use-the-passport-jwt-Strategy"><span class="toc-number">3.6.</span> <span class="toc-text">How do I use the passport-jwt Strategy??</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intro-to-jsonwebtoken-and-passport-jwt-configuration"><span class="toc-number">3.7.</span> <span class="toc-text">Intro to jsonwebtoken and passport-jwt configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What-about-Angular-How-does-that-handle-JWTs"><span class="toc-number">3.8.</span> <span class="toc-text">What about Angular?  How does that handle JWTs?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-Based-Authentication-Implementation"><span class="toc-number">3.9.</span> <span class="toc-text">JWT Based Authentication Implementation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&text=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&is_video=false&description=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)&body=Check out this article: http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&title=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zachgoll.github.io/blog/2019/choosing-authentication-strategy/&name=A Simple Authentication Strategy for Small Organizations (NodeJS, Express, Angular)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Zach Gollwitzer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/blog/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/blog/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/blog/lib/jquery/jquery.min.js"></script>
<script src="/blog/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/blog/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-149577498-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zachgoll';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


