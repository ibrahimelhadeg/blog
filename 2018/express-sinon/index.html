<!DOCTYPE html>
<html lang=EN>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62489908-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-62489908-6');
    </script>

    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Please refer to this Github repo for all code contained in this post. One of the hardest topics to grasp in coding is that of testing.  Despite what many seasoned developers might say, testing does no">
<meta name="keywords" content="sinon">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing SinonJS Unit Tests for an Express Application">
<meta property="og:url" content="http://zachgoll.github.io/blog/2018/express-sinon/index.html">
<meta property="og:site_name" content="Zach Gollwitzer">
<meta property="og:description" content="Please refer to this Github repo for all code contained in this post. One of the hardest topics to grasp in coding is that of testing.  Despite what many seasoned developers might say, testing does no">
<meta property="og:locale" content="EN">
<meta property="og:updated_time" content="2019-11-25T15:55:49.366Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing SinonJS Unit Tests for an Express Application">
<meta name="twitter:description" content="Please refer to this Github repo for all code contained in this post. One of the hardest topics to grasp in coding is that of testing.  Despite what many seasoned developers might say, testing does no">
    
    
        
          
              <link rel="shortcut icon" href="/blog/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Writing SinonJS Unit Tests for an Express Application</title>
    <!-- styles -->
    <link rel="stylesheet" href="/blog/css/style.css">
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/blog/2018/liars-poker/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/blog/2018/mastery/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zachgoll.github.io/blog/2018/express-sinon/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zachgoll.github.io/blog/2018/express-sinon/&text=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zachgoll.github.io/blog/2018/express-sinon/&is_video=false&description=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Writing SinonJS Unit Tests for an Express Application&body=Check out this article: http://zachgoll.github.io/blog/2018/express-sinon/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zachgoll.github.io/blog/2018/express-sinon/&name=Writing SinonJS Unit Tests for an Express Application&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Brief-Introduction-to-SinonJS"><span class="toc-number">1.</span> <span class="toc-text">Brief Introduction to SinonJS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Preparing-your-Express-Application"><span class="toc-number">2.</span> <span class="toc-text">Preparing your Express Application</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Writing-Unit-Tests-for-Basic-functions"><span class="toc-number">3.</span> <span class="toc-text">Writing Unit Tests for Basic functions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-up-the-test-file"><span class="toc-number">3.1.</span> <span class="toc-text">Setting up the test file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-user-model-js"><span class="toc-number">3.2.</span> <span class="toc-text">Testing user-model.js</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Writing-Unit-Tests-for-Express-routes"><span class="toc-number">4.</span> <span class="toc-text">Writing Unit Tests for Express routes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-route"><span class="toc-number">4.1.</span> <span class="toc-text">Register route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-by-ID-route"><span class="toc-number">4.2.</span> <span class="toc-text">Get by ID route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authenticate-by-ID-and-password-route"><span class="toc-number">4.3.</span> <span class="toc-text">Authenticate by ID and password route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writing-the-tests"><span class="toc-number">4.4.</span> <span class="toc-text">Writing the tests</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Debugging-SinonJS-unit-tests"><span class="toc-number">5.</span> <span class="toc-text">Debugging SinonJS unit tests</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Writing SinonJS Unit Tests for an Express Application
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Zach Gollwitzer</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-10-20T21:57:37.000Z" itemprop="datePublished">2018-10-20</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/blog/tags/sinon/">sinon</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Please <a href="https://github.com/zachgoll/sinon-unit-testing-example" target="_blank" rel="noopener">refer to this Github repo</a> for all code contained in this post.</p>
<p>One of the hardest topics to grasp in coding is that of testing.  Despite what many seasoned developers might say, testing does not come naturally to anyone–especially when your code has nested callbacks, promises, and external dependencies that behave unexpectedly.  As a self-taught developer, it took me a while to understand the benefits of testing code, and even longer to finally dedicate myself to learning the art of testing.  Although I am no seasoned testing engineer, I wanted to share a quick tutorial on how to test one of the most common types of applications for any web developer–an Express app.</p>
<p>In this tutorial, I will go through the following topics.</p>
<ol>
<li>A Brief Introduction to SinonJS</li>
<li>Getting your Express App ready for testing (requires small refactor)</li>
<li>Writing Unit Tests for basic functions </li>
<li>Writing Unit Tests for Express routes</li>
<li>Debugging Unit Tests (often overlooked, but extremely useful!)</li>
</ol>
<h1 id="Brief-Introduction-to-SinonJS"><a href="#Brief-Introduction-to-SinonJS" class="headerlink" title="Brief Introduction to SinonJS"></a>Brief Introduction to SinonJS</h1><p>Recreating the wheel is not my intention for this post, so I will not cover the basics of using SinonJS but rather refer readers to <a href="Jani Hartikainen">Jani Hartikainen’s guide on SinonJS</a> (I have no relationship with Jani nor receive affiliate revenue for promoting this guide.).  It is slightly outtdated but covers 99% of the things that you might need to know about using SinonJS for javascript unit testing.</p>
<p>In a nutshell, SinonJS allows you to test the code written below easily.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyExternalLibrary = <span class="built_in">require</span>(<span class="string">'./external-library'</span>);</span><br><span class="line"><span class="keyword">const</span> AnotherLibrary = <span class="built_in">require</span>(<span class="string">'./another-library'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCustomClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(numbers) &#123;</span><br><span class="line">        <span class="keyword">this</span>.numbers = numbers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    calculateAverage() &#123;</span><br><span class="line">        <span class="keyword">const</span> nums = <span class="keyword">this</span>.numbers;</span><br><span class="line">        <span class="keyword">if</span> (AnotherLibrary.validateNums(nums)) &#123;</span><br><span class="line">            <span class="keyword">return</span> MyExternalLibrary.calcAvg(<span class="keyword">this</span>.numbers);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Numbers not valid'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyCustomClass;</span><br></pre></td></tr></table></figure>
<p>There is no significance to the example above; it is entirely made up and random.  If we wanted to test the <code>calculateAverage()</code> method of <code>MyCustomClass</code>, we need to ensure that the external libraries used by this method do not interfere with what we are actually testing.  The goal of unit testing the <code>calculateAverage()</code> method is to make sure that given some inputs, we receive desired outputs.  We do not care how <code>AnotherLibrary.validateNums()</code> or <code>MyExternalLibrary.calcAvg()</code> works.  We need to make sure that these two <em>external</em> methods behave how we want them to.  The only thing we care about is the following:</p>
<ol>
<li>If <code>this.numbers</code> is a <em>valid</em> array of numbers (i.e. does not have any text characters or special characters), we expect <code>calculateAverage()</code> to return the average of this array of numbers.</li>
<li>If <code>this.numbers</code> is <em>invalid</em>, we expect that <code>calculateAverage()</code> will throw an error.</li>
</ol>
<p>We don’t care to know if the average that is returned by <code>MyExternalLibrary.calcAvg()</code> is actually correct.  We would check that fact in a separate unit test.</p>
<p>This is where SinonJS comes in.  Sinon allows us to “stub” both <code>AnotherLibrary.validateNums()</code> and <code>MyExternalLibrary.calcAvg()</code> and force them to return the values that we desire.  In this specific example, we would probably want to write two separate unit tests.  First, we want to test the case where <code>AnotherLibrary.validateNums()</code> returns false, and second, where it returns true.  We can do this easily with Sinon.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'My Unit Tests'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'When AnotherLibrary.validateNums() returns true, we should receive the average of the numbers array'</span>, () =&gt; &#123;</span><br><span class="line">        sinon.stub(AnotherLibrary, <span class="string">'validateNums'</span>).returns(<span class="literal">true</span>);</span><br><span class="line">        sinon.stub(MyExternalLibrary, <span class="string">'calcAvg'</span>).returns(<span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> myClass = <span class="keyword">new</span> MyCustomClass([<span class="number">2</span>, <span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> results = myClass.calculateAverage();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// The average of 2 and 4 is not 5, but the reason we make this assertion is because above, we declared that the </span></span><br><span class="line">        <span class="comment">// MyExternalLibrary.calcAvg() method returns 5, and remember, we don't care if that method actually works correctly here</span></span><br><span class="line">        expect(results).to.be.equal(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We altered the behavior of a method for this specific test but need to restore it in case other tests </span></span><br><span class="line">        <span class="comment">// alter its behavior in a different way</span></span><br><span class="line">        AnotherLibrary.validateNums.restore();</span><br><span class="line">        MyExternalLibrary.calcAvg.restore();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When AnotherLibrary.validateNums() returns false, we should expect an Error thrown.'</span>, () =&gt; &#123;</span><br><span class="line">        sinon.stub(AnotherLibrary, <span class="string">'validateNums'</span>).returns(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> myClass = <span class="keyword">new</span> MyCustomClass([<span class="number">2</span>, <span class="number">4</span>]);</span><br><span class="line">        <span class="keyword">const</span> errorMsg = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Numbers not valid'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> results = myClass.calculateAverage();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// The average of 2 and 4 is 3</span></span><br><span class="line">        expect(results).to.be.equal(errorMsg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We altered the behavior of a method for this specific test but need to restore it in case other tests </span></span><br><span class="line">        <span class="comment">// alter its behavior in a different way</span></span><br><span class="line">        AnotherLibrary.validateNums.restore();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Please note that the above code has not been tested and may contain a few syntax errors, but that is not the point.  The point is to convey the usefulness of SinonJS for our testing needs.  We manually controlled the behavior of external libraries so that we can disregard how they work under the hood, and focus on the specific piece of code that we are trying to test.</p>
<p>Again, if you want a full tutorial on how to use SinonJS, I suggest looking at the <a href="https://sinonjs.org/releases/v7.0.0/" target="_blank" rel="noopener">documentation</a> and downloading <a href="https://codeutopia.net/" target="_blank" rel="noopener">Jani’s guide</a>.</p>
<h1 id="Preparing-your-Express-Application"><a href="#Preparing-your-Express-Application" class="headerlink" title="Preparing your Express Application"></a>Preparing your Express Application</h1><p>Unit testing Express routes can be challenging; especially if your application is not setup in a way that allows for modular testing.  We are going to refactor our Express app so that testing it is much easier (idea credit comes from <a href="http://evanshortiss.com/development/javascript/2016/04/15/express-testing-using-ioc.html" target="_blank" rel="noopener">Evan Shortiss’s Blog</a>).</p>
<p>Most Express applications are built in the following way.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: app.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up the Express app object</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Grab the port number from some config file</span></span><br><span class="line"><span class="keyword">const</span> port = config.port || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the app to use the user-routes.js file for routing</span></span><br><span class="line">app.use(<span class="string">'/'</span>, <span class="built_in">require</span>(<span class="string">'./user-routes'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serve the app </span></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening on <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the app object for other files to use</span></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: user-routes.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Require the Express Router object</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// At http://HOST/api, use the routes found in the api/ directory</span></span><br><span class="line">router.use(<span class="string">'/api'</span>, <span class="built_in">require</span>(<span class="string">'./api'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// At http://HOST/, you will see 'This is the home page' displayed </span></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">'This is the home page'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>Most Express applications use this simple structure, and honestly, it is the simplest way to go.  But if you are looking to test your Express application, this poses a problem, because as you may notice, we are splitting our routes into many different files that all depend on each other to function.  Therefore, if I wanted to test one of my api routes, I would have to require in the <code>routes/index.js</code> file as well.  The goal of the refactor that we are going to do is to eliminate this chain of route dependencies, and create the ability to test one route file at a time.  How do we go about this?  We need to turn all of our route files into exported functions that take the Express app object as arguments.  Below is a simple refactor of the above app.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * app.js </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./user-routes'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up the Express app object</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Grab the port number from some config file</span></span><br><span class="line"><span class="keyword">const</span> port = config.port || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// THIS LINE IS THE ONLY DIFFERENCE!</span></span><br><span class="line">routes(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serve the app </span></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening on <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the app object for other files to use</span></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: user-routes.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Require the Express Router object</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Require the api routes file</span></span><br><span class="line"><span class="keyword">const</span> apiRoutes = <span class="built_in">require</span>(<span class="string">'./api'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    app.use(<span class="string">'/'</span>, router);</span><br><span class="line"></span><br><span class="line">    apiRoutes(app);</span><br><span class="line"></span><br><span class="line">    router.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">        res.send(<span class="string">'This is the home page'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I know the above code may appear confusing at first, but please take your time reading into it and understanding exactly what is happening.  After adjusting your way of thinking, this method will seem a lot less complicated than it initially appears.</p>
<p>Once you have refactored all of your routes to look like this, you are ready to start testing!</p>
<h1 id="Writing-Unit-Tests-for-Basic-functions"><a href="#Writing-Unit-Tests-for-Basic-functions" class="headerlink" title="Writing Unit Tests for Basic functions"></a>Writing Unit Tests for Basic functions</h1><p>In order to demonstrate the full capability of SinonJS in testing Express applications, we are going to start with some basic functions to test, which will eventually play a role in our route tests.  Below are the files of a simple Express application that we will test.  I suggest reading through and making yourself familiar with the structure before proceeding.  Please note that all files are located in the same directory for ease of example (Most Express apps would be split into folders).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * app.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./user-routes'</span>);</span><br><span class="line"><span class="keyword">const</span> databaseConfig = <span class="built_in">require</span>(<span class="string">'./config/database'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up the Express app object</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Using Mongoose as an interface to our MongoDB database</span></span><br><span class="line">mongoose.connect(databaseConfig.database, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> connection = mongoose.connection;</span><br><span class="line"></span><br><span class="line">connection.on(<span class="string">'connected'</span>, () =&gt; &#123; logger.info(<span class="string">`App connected to database <span class="subst">$&#123;databaseConfig.dbName&#125;</span>`</span>) &#125;);</span><br><span class="line">connection.on(<span class="string">'error'</span>, (err) =&gt; &#123; logger.error(<span class="string">`Database error: <span class="subst">$&#123;err&#125;</span>`</span>) &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Grab the port number from some config file</span></span><br><span class="line"><span class="keyword">const</span> port = config.port || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the body parser for easily interpreting requests with json</span></span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line"><span class="comment">// THIS LINE IS THE ONLY DIFFERENCE!</span></span><br><span class="line">routes(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serve the app </span></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening on <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export the app object for other files to use</span></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * user-routes.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Require the Express Router object</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    app.use(<span class="string">'/'</span>, router);</span><br><span class="line"></span><br><span class="line">    router.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">        res.send(<span class="string">'This is the home page'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * user-model.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// User schema for mongodb</span></span><br><span class="line"><span class="keyword">const</span> UserSchema = mongoose.Schema(&#123;</span><br><span class="line">	name: &#123;</span><br><span class="line">		type: <span class="built_in">String</span></span><br><span class="line">	&#125;,</span><br><span class="line">	email: &#123;</span><br><span class="line">		type: <span class="built_in">String</span>,</span><br><span class="line">		required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    password: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">module</span>.exports = mongoose.model(<span class="string">'User'</span>, UserSchema);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.getUserById = <span class="function">(<span class="params">id, callback</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		User.findById(id, callback);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		callback(err);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.addUser = <span class="function">(<span class="params">newUser, callback</span>) =&gt;</span> &#123;</span><br><span class="line">	bcrypt.genSalt(<span class="number">10</span>, (err, salt) =&gt; &#123;</span><br><span class="line">		bcrypt.hash(newUser.password, salt, (err, hash) =&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">			newUser.password = hash;</span><br><span class="line">			newUser.save(callback);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.comparePassword = <span class="function">(<span class="params">password, hash, callback</span>) =&gt;</span> &#123;</span><br><span class="line">	bcrypt.compare(password, hash, (err, isMatch) =&gt; &#123;</span><br><span class="line">		callback(err, isMatch);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Please note that the routes file is incomplete and I will be adding more routes to it as we move forward.</em></p>
<p>This application is as simple as it gets.  I am using MongoDB as my database, and my only collection is the users collection.  To clarify things further, we can see that the <code>user-model.js</code> file exports a Mongoose model and a few helper functions for authentication.  When we import this file into a route file, we will get an object that functions like a class object with static methods.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> comparePassword () &#123;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">static</span> addUser() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> getUserById() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructor to the Mongoose.Model object takes the doc name and fields</span></span><br><span class="line">    <span class="keyword">constructor</span>(doc, fields) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These methods are part of the Mongoose.Model object and we did not create them</span></span><br><span class="line">    save() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These methods are part of the Mongoose.Model object and we did not create them</span></span><br><span class="line">    findById()&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other methods found at https://mongoosejs.com/docs/api.html#Model</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above exercise is not necessary, but I think it helps one further understand how our <code>user-model.js</code> file is functioning.</p>
<p>The first step in testing this application is to write unit tests for the <code>user-model.js</code> file.  Looking at the file, we want to ensure that: </p>
<ol>
<li>User model exists</li>
<li>getUserById() works correctly </li>
<li>addUser() works correctly</li>
<li>comparePassword() works correctly</li>
</ol>
<p>I know all of these functions are rather simple, but it is still important to test them, and they will be great starter examples.</p>
<h2 id="Setting-up-the-test-file"><a href="#Setting-up-the-test-file" class="headerlink" title="Setting up the test file"></a>Setting up the test file</h2><p>Before testing, we need to setup our testing environment.  We will add a file called <code>all-tests.js</code>.  Again, this would usually be split into multiple files in the <code>test/</code> folder, but we are keeping everything in one file to avoid too much complexity.  For our testing purposes, we will be using the Chai Expect assertion library for our tests.  Here is the basic setup for our testing.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: all-tests.js </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// More verbose assertion library</span></span><br><span class="line"><span class="keyword">const</span> &#123; expect &#125; = <span class="built_in">require</span>(<span class="string">'chai'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'User Model Tests'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it (<span class="string">'User model exists'</span>, () =&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When getUserById() is a success, we should receive the user from the db'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When getUserById() fails, we should receive an error'</span>), () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When addUser() is a success, the user should be added to the database with hash as password'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">    it(<span class="string">'When addUser() is a failure, the user will not be added to the database and we will get error'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When password matches hash, comparePassword() will return true'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When password does not match hash, comparePassword() will return false'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The <code>all-tests.js</code> file will eventually contain both our User model tests and our User routes tests, but for now, we just have the User model tests.  As you can see, we have several tests for just a few methods.  This is not always necessary, but is appropriate for this tutorial.  A few things to point out in the code above:</p>
<ul>
<li>You can see that many of the unit tests have a keyword called <code>done</code>.  This is part of the Mocha testing library, and allows you to tell Mocha when a specific asynchronous function has completed.  This will come in handy since we are dealing with callbacks and http requests.</li>
<li>Notice there is a <code>beforeEach()</code> and <code>afterEach()</code> function at the top of the describe block.  With Mocha, these functions will be called before each of the unit tests and after each of the unit tests.  They are useful for setting up things that are needed for each and every test.</li>
<li>We have required in a few external libraries like bcrypt.js.  This is because our <code>user-model.js</code> file uses this library and we will need to “stub” it out for our tests.</li>
<li>Quick tip for actually running the tests:  Go to your <code>package.json</code> file and add the mocha command to your test scripts using nodemon.  This allows the tests to reload automatically after you update the test files.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">&quot;test&quot;: &quot;nodemon --exec &apos;mocha test&apos;&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="Testing-user-model-js"><a href="#Testing-user-model-js" class="headerlink" title="Testing user-model.js"></a>Testing user-model.js</h2><p>We are ready to test our functions, but one of the biggest challenges in unit testing is understanding <strong>what</strong> you are trying to test.  We will start with the simplest one.  We want to make sure that the User model exists when we require it into a file.  To test this, we will simply write the following (please note from here on out, I will only be including the relevant snippet of code rather than the entire test file).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"></span><br><span class="line">it (<span class="string">'User model exists'</span>, () =&gt; &#123;</span><br><span class="line">    expect(User.model).to.exist;</span><br><span class="line">    expect(User.collection.name).to.equal(<span class="string">'users'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The reason we test this is primarily to make sure that we are requiring in the correct Model.  We make sure that the model object exists and make sure that one of its properties equals what we would expect (I chose the collection name because this should not change).  This initial test will also get us on the right foot and confirm that our test suite is working correctly in general.</p>
<p>Next, we want to test the <code>getUserById()</code> function.  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When getUserById() is a success, we should receive the user from the db'</span>, () =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We first set up a dummy user that we will force as the return value of User.findById</span></span><br><span class="line">    <span class="keyword">const</span> expectedUser = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        name: <span class="string">'Firstname'</span>,</span><br><span class="line">        email: <span class="string">'firstname@email.com'</span>,</span><br><span class="line">        password: <span class="string">'somepassword'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Alter the behavior of User.findById() to return our expectedUser</span></span><br><span class="line">    sinon.stub(User, <span class="string">'findById'</span>).yieldsAsync(expectedUser);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the actual function we are unit testing</span></span><br><span class="line">    User.getUserById(<span class="string">'12345'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We expect that the user returned from our function will equal </span></span><br><span class="line">        <span class="comment">// the user we made it return</span></span><br><span class="line">        expect(user).to.equal(expectedUser);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Asserting that the method called as User.findById('12345');</span></span><br><span class="line">    sinon.assert.calledWith(User.findById, <span class="string">'12345'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always remember to restore the functionality of your functions or other unit tests will break!</span></span><br><span class="line">    User.findById.restore();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When getUserById() fails, we should receive an error'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Create stub on method and force to throw an error</span></span><br><span class="line">    sinon.stub(User, <span class="string">'findById'</span>);</span><br><span class="line">    <span class="keyword">const</span> expectedError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'could not find user'</span>);</span><br><span class="line">    User.findById.throws(expectedError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We use a Sinon spy because we want to know the parameter that the callback used</span></span><br><span class="line">    <span class="keyword">const</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the function we are testing</span></span><br><span class="line">    User.getUserById(<span class="string">'12345'</span>, callback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Asserting that the callback is called with the expectedError as a parameter</span></span><br><span class="line">    sinon.assert.calledWith(callback, expectedError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always remember to restore the functionality of your functions or other unit tests will break!</span></span><br><span class="line">    User.findById.restore();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>I know some of the above code looks a bit intimidating with “stubs” and “spies”, but if you brush up on your SinonJS, you will quickly learn what exactly is going on.  The real topic I want to cover here is the <em>why</em> behind things, and the methodology.  In the first unit test, we assumed that our function was called with some parameters and did not throw any errors.  We made sure that given some inputs, we receive our expected outputs.  It may seem redundant to force some method to return a specific value, but it is a great way to test the core functionality of a method.  In the second test, we considered the only other scenario that might happen in our code.  What if the method throws an error?  Have we handled it?  In this case, yes, we have handled the error with a <code>try {} catch {}</code> block.  In many cases, writing unit tests forces us to write clean and resilient code.  Before I wrote the unit test for this particular method, I did not have a try/catch block, which means that if my app has trouble connecting to the database and throws an errror, it will crash.  By testing for this error scenario, I realized that I needed to handle this error condition.</p>
<p>I will spend less time on the remaining two methods, but here they are.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When addUser() is a success, the user should be added to the database with hash as password'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a dummy user</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        name: <span class="string">'some name'</span>, </span><br><span class="line">        password: <span class="string">'some password'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the function we are testing with the dummy user as an argument</span></span><br><span class="line">    User.addUser(user, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We expect the original password to not match the new one because this method </span></span><br><span class="line">        <span class="comment">// should transform the password into a secure hash for storage in the database</span></span><br><span class="line">        expect(user.password).to.not.equal(<span class="string">'some password'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Be sure to call done to tell Mocha that the asynchronous execution has finished</span></span><br><span class="line">        done();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When addUser() is a failure, the user will not be added to the database and we will get error'</span>, () =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create dummy user</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        name: <span class="string">'some name'</span>, </span><br><span class="line">        password: <span class="string">'some password'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an error to throw</span></span><br><span class="line">    <span class="keyword">const</span> expectedError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'some error'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Force the bcrypt.genSalt() method to throw our expected error</span></span><br><span class="line">    sinon.stub(bcrypt, <span class="string">'genSalt'</span>).throws(expectedError);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Call the function we are testing in a try/catch block, and assert that we arrived at the catch block</span></span><br><span class="line">    <span class="comment">// with the expected error</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        User.addUser(user, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        sinon.assert.threw(bcrypt.genSalt, expectedError);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Remember to restore!</span></span><br><span class="line">    bcrypt.genSalt.restore();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When password matches hash, comparePassword() will return true'</span>, (done) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> password = <span class="string">'some password'</span>;</span><br><span class="line">    <span class="keyword">const</span> salt = bcrypt.genSaltSync(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">const</span> hash = bcrypt.hashSync(password, salt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// No need to create any stubs.  Just call the method and check that the results are </span></span><br><span class="line">    <span class="comment">// as expected.  We expect that given the above inputs, our password will be a match</span></span><br><span class="line">    User.comparePassword(password, hash, (err, isMatch) =&gt; &#123;</span><br><span class="line">        expect(isMatch).to.be.true;</span><br><span class="line">        expect(err).to.be.null;</span><br><span class="line">        done();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">it(<span class="string">'When password does not match hash, comparePassword() will return false'</span>, (done) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create our expected error</span></span><br><span class="line">    <span class="keyword">const</span> expectedError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'comparison did not work'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a stub on the bcrypt.compare() method and force it to throw our expectedError</span></span><br><span class="line">    sinon.stub(bcrypt, <span class="string">'compare'</span>).yieldsAsync(expectedError);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create a spy on the callback so we can determine what arguments it was called with</span></span><br><span class="line">    <span class="keyword">const</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the function we are testing with the spy callback, and make sure to call done() to </span></span><br><span class="line">    <span class="comment">// let Mocha know that the async function has completed</span></span><br><span class="line">    User.comparePassword(<span class="string">'some password'</span>, <span class="string">'some salt'</span>, callback);</span><br><span class="line">    done();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We expect that the callback will be called once with the expectedError as an argument</span></span><br><span class="line">    sinon.assert.calledOnce(callback);</span><br><span class="line">    sinon.assert.calledWith(callback, expectedError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember to restore!</span></span><br><span class="line">    bcrypt.compare.restore();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As you can see, there is a common pattern with our tests.  We setup the conditions we want to use as <em>inputs</em> for our test, we call the function we are testing, and we assert that the <em>outputs</em> are what we should expect based on the inputs.  This ensures that all of our functions perform predictably, and if we enhance the code, add a feature, etc., we know that this new feature has not broken anything in our functions.</p>
<h1 id="Writing-Unit-Tests-for-Express-routes"><a href="#Writing-Unit-Tests-for-Express-routes" class="headerlink" title="Writing Unit Tests for Express routes"></a>Writing Unit Tests for Express routes</h1><p>Writing unit tests for Express routes is a bit trickier than simple utility functions like the ones above.  The reason is due to nested, asynchronous calls in the form of callbacks and promises.  Testing Express routes takes some patience and requires the testing engineer to break each route into many steps; stubbing functions along the way.  Before we get started, let’s look at the routes we will be testing and get a preliminary idea of how we might test them.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * user-routes.js</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Require the Express Router object</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'express'</span>).Router();</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    app.use(<span class="string">'/'</span>, router);</span><br><span class="line"></span><br><span class="line">    router.get(<span class="string">'/'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">        res.send(<span class="string">'This is the home page'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a user</span></span><br><span class="line">    router.post(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> newUser = <span class="keyword">new</span> User(&#123;</span><br><span class="line">            name: req.body.name,</span><br><span class="line">            email: req.body.email,</span><br><span class="line">            password: req.body.password</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        User.addUser(newUser, (err, user) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err)&#123;</span><br><span class="line">                res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">'Failed to register'</span>&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">msg</span>: <span class="string">'User registered!'</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get a user</span></span><br><span class="line">    router.get(<span class="string">'/:id'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        User.getUserById(req.params.id, (err, user) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) next(err);</span><br><span class="line">            <span class="keyword">if</span> (!user)&#123;</span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Failed to authenticate user"</span>&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">msg</span>: user &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Authenticate and login a user based on id and password</span></span><br><span class="line">    router.post(<span class="string">'/authenticate/:id'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> password = req.body.password;</span><br><span class="line">        <span class="keyword">const</span> id = req.params.id;</span><br><span class="line"></span><br><span class="line">        User.getUserById(id, (err, user) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) next(err);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!user)&#123;</span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Failed to authenticate user"</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            User.comparePassword(password, user.password, (err, isMatch) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span>(err) next(err);</span><br><span class="line">                <span class="keyword">if</span>(isMatch)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Token expires in 1 month = 2,629,746 seconds</span></span><br><span class="line">                    <span class="keyword">const</span> token = jwt.sign(&#123;<span class="attr">data</span>: user&#125;, databaseConfig.secret, &#123;</span><br><span class="line">                        expiresIn: <span class="number">2629746</span></span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                    res.json(&#123;</span><br><span class="line">                        success: <span class="literal">true</span>,</span><br><span class="line">                        token: <span class="string">'Bearer '</span> + token,</span><br><span class="line">                        user: &#123;</span><br><span class="line">                            id: user._id,</span><br><span class="line">                            name: user.name,</span><br><span class="line">                            email: user.email</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Wrong password"</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We have three main routes to our applicaton.</p>
<ol>
<li><code>/register</code></li>
<li><code>/:id</code></li>
<li><code>/authenticate/:id</code></li>
</ol>
<p>The register route will use our <code>User.addUser()</code> method to add a user to the database.  The id route will perform a get request and use the <code>User.getUserById()</code> method to retrieve an existing user from the database.  Finally, the authenticate route will use the <code>User.compare()</code> method to check the login credentials of a user that is trying to login.</p>
<p>Let’s walk through each of these routes and discuss a strategy as to how we might test them.</p>
<h2 id="Register-route"><a href="#Register-route" class="headerlink" title="Register route"></a>Register route</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register a user</span></span><br><span class="line">router.post(<span class="string">'/register'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newUser = <span class="keyword">new</span> User(&#123;</span><br><span class="line">        name: req.body.name,</span><br><span class="line">        email: req.body.email,</span><br><span class="line">        password: req.body.password</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    User.addUser(newUser, (err, user) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err)&#123;</span><br><span class="line">            res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">'Failed to register'</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">msg</span>: <span class="string">'User registered!'</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The register route can be broken into two distinct parts.  First, we <em>instantiate</em> a new <em>instance</em> of the User class at the beginning of the route.  We then take this class instance and pass it to our <code>User.addUser()</code> method, which will return with one of two json responses.  At first glance, we know that we are going to need a unit test for the successful condition and an error condition.  We also see that since the route is using <code>User.addUser()</code> (which we already tested and don’t care about here), we will need to “stub” this method and force it to behave in a certain.</p>
<h2 id="Get-by-ID-route"><a href="#Get-by-ID-route" class="headerlink" title="Get by ID route"></a>Get by ID route</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get a user</span></span><br><span class="line">router.get(<span class="string">'/:id'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    User.getUserById(req.params.id, (err, user) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) next(err);</span><br><span class="line">        <span class="keyword">if</span> (!user)&#123;</span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Failed to authenticate user"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">msg</span>: user &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Arguably the simplest of the three routes, this route uses the <code>User.getUserById()</code> method to retrieve a user based on his/her ID from the database.  As with the previous route, we have the <code>getUserById()</code> method which we have already tested.  Since we already tested it, we don’t care to know if it works in this test, so we need to “stub” it out and force it to behave a certain way (success, error).</p>
<h2 id="Authenticate-by-ID-and-password-route"><a href="#Authenticate-by-ID-and-password-route" class="headerlink" title="Authenticate by ID and password route"></a>Authenticate by ID and password route</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authenticate and login a user based on id and password</span></span><br><span class="line">router.post(<span class="string">'/authenticate/:id'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> password = req.body.password;</span><br><span class="line">    <span class="keyword">const</span> id = req.params.id;</span><br><span class="line"></span><br><span class="line">    User.getUserById(id, (err, user) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) next(err);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!user)&#123;</span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Failed to authenticate user"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User.comparePassword(password, user.password, (err, isMatch) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(err) next(err);</span><br><span class="line">            <span class="keyword">if</span>(isMatch)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Token expires in 1 month = 2,629,746 seconds</span></span><br><span class="line">                <span class="keyword">const</span> token = jwt.sign(&#123;<span class="attr">data</span>: user&#125;, databaseConfig.secret, &#123;</span><br><span class="line">                    expiresIn: <span class="number">2629746</span></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                res.json(&#123;</span><br><span class="line">                    success: <span class="literal">true</span>,</span><br><span class="line">                    token: <span class="string">'Bearer '</span> + token,</span><br><span class="line">                    user: &#123;</span><br><span class="line">                        id: user._id,</span><br><span class="line">                        name: user.name,</span><br><span class="line">                        email: user.email</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">msg</span>: <span class="string">"Wrong password"</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This is the most difficult route to test because it uses two separate external libraries.  One of the libraries is asynchronous (the <code>User.compare()</code> method) while the other is synchronous (the <code>jwt.sign()</code> method).  We will need to remember these details when testing.  For this unit test, we will need to create Sinon stubs for both of these methods.</p>
<h2 id="Writing-the-tests"><a href="#Writing-the-tests" class="headerlink" title="Writing the tests"></a>Writing the tests</h2><p>We have gone through each of the routes, but have not yet discussed how we are going to perform the actual unit tests.  How are we going to simulate an HTTP request in a testing environment?   Well, this is where our <code>supertest</code> library comes in handy.  For each of our tests, we are going to create a minimal Express application and use the <code>supertest</code> library to simulate each route call.  Here is what our test file should look like at this point (Notice that we have placed the route tests in a new Describe block).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: all-tests.js </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./user-routes'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// More verbose assertion library</span></span><br><span class="line"><span class="keyword">const</span> &#123; expect &#125; = <span class="built_in">require</span>(<span class="string">'chai'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'User Route Tests'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> app, request;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create an express application object</span></span><br><span class="line">        app = express();</span><br><span class="line">        app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bind our routes to our application using the method explained earlier</span></span><br><span class="line">        routes(app);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add newly created app instance to supertest object</span></span><br><span class="line">        request = supertest(app);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(<span class="string">'User can register successfully at the /register route'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'/register route fails'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'Can get user from /:id route'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'Cannot get user from /:id route -- User with id does not exist'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'User is successfully authenticated'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'User typed in the wrong password'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'User Model Tests'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When addUser() is a success, the user should be added to the database with hash as password'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a dummy user</span></span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">            name: <span class="string">'some name'</span>, </span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call the function we are testing with the dummy user as an argument</span></span><br><span class="line">        User.addUser(user, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We expect the original password to not match the new one because this method </span></span><br><span class="line">            <span class="comment">// should transform the password into a secure hash for storage in the database</span></span><br><span class="line">            expect(user.password).to.not.equal(<span class="string">'some password'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Be sure to call done to tell Mocha that the asynchronous execution has finished</span></span><br><span class="line">            done();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When addUser() is a failure, the user will not be added to the database and we will get error'</span>, () =&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create dummy user</span></span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">            name: <span class="string">'some name'</span>, </span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create an error to throw</span></span><br><span class="line">        <span class="keyword">const</span> expectedError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'some error'</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Force the bcrypt.genSalt() method to throw our expected error</span></span><br><span class="line">        sinon.stub(bcrypt, <span class="string">'genSalt'</span>).throws(expectedError);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Call the function we are testing in a try/catch block, and assert that we arrived at the catch block</span></span><br><span class="line">        <span class="comment">// with the expected error</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            User.addUser(user, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            sinon.assert.threw(bcrypt.genSalt, expectedError);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Remember to restore!</span></span><br><span class="line">        bcrypt.genSalt.restore();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When password matches hash, comparePassword() will return true'</span>, (done) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> password = <span class="string">'some password'</span>;</span><br><span class="line">        <span class="keyword">const</span> salt = bcrypt.genSaltSync(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">const</span> hash = bcrypt.hashSync(password, salt);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// No need to create any stubs.  Just call the method and check that the results are </span></span><br><span class="line">        <span class="comment">// as expected.  We expect that given the above inputs, our password will be a match</span></span><br><span class="line">        User.comparePassword(password, hash, (err, isMatch) =&gt; &#123;</span><br><span class="line">            expect(isMatch).to.be.true;</span><br><span class="line">            expect(err).to.be.null;</span><br><span class="line">            done();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'When password does not match hash, comparePassword() will return false'</span>, (done) =&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create our expected error</span></span><br><span class="line">        <span class="keyword">const</span> expectedError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'comparison did not work'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a stub on the bcrypt.compare() method and force it to throw our expectedError</span></span><br><span class="line">        sinon.stub(bcrypt, <span class="string">'compare'</span>).yieldsAsync(expectedError);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create a spy on the callback so we can determine what arguments it was called with</span></span><br><span class="line">        <span class="keyword">const</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call the function we are testing with the spy callback, and make sure to call done() to </span></span><br><span class="line">        <span class="comment">// let Mocha know that the async function has completed</span></span><br><span class="line">        User.comparePassword(<span class="string">'some password'</span>, <span class="string">'some salt'</span>, callback);</span><br><span class="line">        done();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We expect that the callback will be called once with the expectedError as an argument</span></span><br><span class="line">        sinon.assert.calledOnce(callback);</span><br><span class="line">        sinon.assert.calledWith(callback, expectedError);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remember to restore!</span></span><br><span class="line">        bcrypt.compare.restore();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Above, I have printed the entire test file all in one.  This includes both route unit tests and User model unit tests.  Let’s focus in on the <code>beforeEach()</code> block in the route unit test describe block.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an express application object</span></span><br><span class="line">    app = express();</span><br><span class="line">    app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind our routes to our application using the method explained earlier</span></span><br><span class="line">    routes(app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add newly created app instance to supertest object</span></span><br><span class="line">    request = supertest(app);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As you can see, we are creating minimalistic Express application that has our routes file attached to it, and then we are passing this minimal Express application to the supertest object which will allow us to simulate HTTP requests in each of our unit tests.  With this particular tutorial it is not immediately apparent the usefulness of using an exported function for our routes file, but imagine if we had 10 different route files.  How would we go about testing a single route file when all 10 of them depend on each other?  Let’s imagine that we had route files named <code>routes-1.js</code>, <code>routes-2.js</code>, and <code>routes-3.js</code>.  Certainly, we would want to test each of these files one at a time.  With our newly structured Express application, we can.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes1 = <span class="built_in">require</span>(<span class="string">'/routes-1'</span>);</span><br><span class="line"><span class="keyword">const</span> routes2 = <span class="built_in">require</span>(<span class="string">'/routes-2'</span>);</span><br><span class="line"><span class="keyword">const</span> routes3 = <span class="built_in">require</span>(<span class="string">'/routes-3'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Routes 1 Tests'</span>, () =&gt; &#123;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        app = express();</span><br><span class="line">        app.use(bodyParser.json());</span><br><span class="line">        routes(app);</span><br><span class="line">        request = supertest(app);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Routes 2 Tests'</span>, () =&gt; &#123;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        app = express();</span><br><span class="line">        app.use(bodyParser.json());</span><br><span class="line">        routes2(app);</span><br><span class="line">        request = supertest(app);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Routes 3 Tests'</span>, () =&gt; &#123;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        app = express();</span><br><span class="line">        app.use(bodyParser.json());</span><br><span class="line">        routes3(app);</span><br><span class="line">        request = supertest(app);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Having this separation of routes dramatically increases the ease in which we can test each route file.</p>
<p>Finally, it is time to write the tests.  Below are the completed unit tests with comments throughout the code.  I suggest perusing through the comments to understand what is going on better.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File: all-tests.js </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">'sinon'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./user-model'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./user-routes'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// More verbose assertion library</span></span><br><span class="line"><span class="keyword">const</span> &#123; expect &#125; = <span class="built_in">require</span>(<span class="string">'chai'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'User Route Tests'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> app, request;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create an express application object</span></span><br><span class="line">        app = express();</span><br><span class="line">        app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bind our routes to our application using the method explained earlier</span></span><br><span class="line">        routes(app);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add newly created app instance to supertest object</span></span><br><span class="line">        request = supertest(app);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Always a good idea to write a simple test to make sure that you have everything setup </span></span><br><span class="line"><span class="comment">     * correctly before getting into the more complex tests</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    it(<span class="string">'Base route works'</span>, (done) =&gt; &#123;</span><br><span class="line">        request</span><br><span class="line">            .get(<span class="string">'/'</span>)</span><br><span class="line">            .expect(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line">                expect(res.text).to.equal(<span class="string">'This is the home page'</span>);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This makes sure that we are pulling from the correct MongoDB collection</span></span><br><span class="line">    it (<span class="string">'User exists and belongs to collection users'</span>, () =&gt; &#123;</span><br><span class="line">        expect(User.model).to.exist;</span><br><span class="line">        expect(User.collection.name).to.equal(<span class="string">'users'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    it(<span class="string">'User can register successfully at the /register route'</span>, (done) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> newUser = &#123;</span><br><span class="line">            name: <span class="string">'Steve Jobs'</span>,</span><br><span class="line">            email: <span class="string">'steve@gmail.com'</span>,</span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">true</span>,</span><br><span class="line">            msg: <span class="string">'User registered!'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * User.addUser() is an async functon, and Sinon does not automatically call the callback</span></span><br><span class="line"><span class="comment">         * We need to call the callback and then let Mocha know that it has completed execution</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        sinon.stub(User, <span class="string">'addUser'</span>).callsArg(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .post(<span class="string">'/register'</span>)</span><br><span class="line">            .send(newUser)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure to restore the stub, otherwise other tests will break</span></span><br><span class="line">                User.addUser.restore();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Since we are comparing two objects, we need the Chai Expect library's </span></span><br><span class="line">                <span class="comment">// deep.equal() method.</span></span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'/register route fails'</span>, (done) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> newUser = &#123;</span><br><span class="line">            invalidProperty: <span class="string">'Steve Jobs'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">false</span>,</span><br><span class="line">            msg: <span class="string">'Failed to register'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We need to call the addUser() method with an error because the user we are</span></span><br><span class="line">        <span class="comment">// trying to add is invalid</span></span><br><span class="line">        sinon.stub(User, <span class="string">'addUser'</span>).callsArgWith(<span class="number">1</span>, <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Route threw error'</span>));</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .post(<span class="string">'/register'</span>)</span><br><span class="line">            .send(newUser)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Always remember to restore stubs!</span></span><br><span class="line">                User.addUser.restore();</span><br><span class="line"></span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'Can get user from /:id route'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> returnedUser = &#123;</span><br><span class="line">            name: <span class="string">'Steve Jobs'</span>,</span><br><span class="line">            email: <span class="string">'steve@gmail.com'</span>,</span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">true</span>,</span><br><span class="line">            msg: returnedUser</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        sinon.stub(User, <span class="string">'getUserById'</span>).callsArgWith(<span class="number">1</span>, <span class="literal">null</span>, returnedUser);</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .get(<span class="string">'/some-id'</span>)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line">                User.getUserById.restore();</span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'Cannot get user from /:id route -- User with id does not exist'</span>, (done) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">false</span>,</span><br><span class="line">            msg: <span class="string">'Failed to find user'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When there is no user, our method passes two arguments -- null for the error </span></span><br><span class="line">        <span class="comment">// and null for the user </span></span><br><span class="line">        sinon.stub(User, <span class="string">'getUserById'</span>).callsArgWith(<span class="number">1</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .get(<span class="string">'/some-id'</span>)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line">                User.getUserById.restore();</span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'User is successfully authenticated'</span>, (done) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> existingUser = &#123;</span><br><span class="line">            _id: <span class="string">'some-id'</span>,</span><br><span class="line">            name: <span class="string">'Steve Jobs'</span>,</span><br><span class="line">            email: <span class="string">'steve@gmail.com'</span>,</span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Rather than stubbing the jwt.sign() method, we can just run it to determine result</span></span><br><span class="line">        <span class="keyword">const</span> token = jwt.sign(&#123;<span class="attr">data</span>: existingUser&#125;, config.secret, &#123;</span><br><span class="line">            expiresIn: <span class="number">2629746</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">true</span>,</span><br><span class="line">            token: <span class="string">'Bearer '</span> + token,</span><br><span class="line">            user: &#123;</span><br><span class="line">                id: existingUser._id,</span><br><span class="line">                name: existingUser.name,</span><br><span class="line">                email: existingUser.email</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We ensure that the user is successfully found in the database and returned through callback</span></span><br><span class="line">        sinon.stub(User, <span class="string">'getUserById'</span>).callsArgWith(<span class="number">1</span>, <span class="literal">null</span>, existingUser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We force the comparePassword() method to return a match</span></span><br><span class="line">        sinon.stub(User, <span class="string">'comparePassword'</span>).callsArgWith(<span class="number">2</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .post(<span class="string">'/authenticate/some-id'</span>)</span><br><span class="line">            .send(existingUser)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Always remember to restore stubs!</span></span><br><span class="line">                User.getUserById.restore();</span><br><span class="line">                User.comparePassword.restore();</span><br><span class="line"></span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'User typed in the wrong password'</span>, (done) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> existingUser = &#123;</span><br><span class="line">            _id: <span class="string">'some-invalid-id'</span>,</span><br><span class="line">            name: <span class="string">'Steve Jobs'</span>,</span><br><span class="line">            email: <span class="string">'steve@gmail.com'</span>,</span><br><span class="line">            password: <span class="string">'some password'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> expectedResponse = &#123;</span><br><span class="line">            success: <span class="literal">false</span>,</span><br><span class="line">            msg: <span class="string">'Wrong password'</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We ensure that the user is successfully found in the database and returned through callback</span></span><br><span class="line">        sinon.stub(User, <span class="string">'getUserById'</span>).callsArgWith(<span class="number">1</span>, <span class="literal">null</span>, existingUser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We force the comparePassword() method to return a mismatch (i.e. the user entered the wrong password)</span></span><br><span class="line">        sinon.stub(User, <span class="string">'comparePassword'</span>).callsArgWith(<span class="number">2</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        request</span><br><span class="line">            .post(<span class="string">'/authenticate/some-invalid-id'</span>)</span><br><span class="line">            .send(existingUser)</span><br><span class="line">            .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">            .expect(<span class="number">200</span>, (err, res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Always remember to restore stubs!</span></span><br><span class="line">                User.getUserById.restore();</span><br><span class="line">                User.comparePassword.restore();</span><br><span class="line"></span><br><span class="line">                expect(res.body).to.deep.equal(expectedResponse);</span><br><span class="line">                done();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Debugging-SinonJS-unit-tests"><a href="#Debugging-SinonJS-unit-tests" class="headerlink" title="Debugging SinonJS unit tests"></a>Debugging SinonJS unit tests</h1><p>One of the most overlooked tools in the NodeJS toolbox is the debugger.  There are ways to use the debugger in any text editor, but I highly suggest downloading <a href="https://code.visualstudio.com/download" target="_blank" rel="noopener">VSCode</a> if you haven’t already because not only is it a wonderful code editor, but it also has a super flexible debugging tool.  This text will not provide a comprehensive tutorial on the debugger, but will get you up and running.</p>
<p>First, click on the bug icon on the left side of VSCode.  This tab will open a sidebar with a Variables, Watch, Call Stack, and Breakpoint window.  You cannot use it immediately because you need to create a configuration.  Find the gear icon at the top of the Debug sidebar and select the <code>launch.json</code> file.  This file can also be found inside the <code>.vscode/</code> directory that is automatically created for each of your VSCode projects.  When you have this open, there should be a button in the bottom right corner that says “Add Configuration…”.  Click this button and select the “{} Node.js: Mocha Tests” configuration.  This will add a new object to your array of configurations.  Close out of launch.json and you are now ready to debug.  Let’s imagine that your test on the <code>User.addUser()</code> method is behaving unexpectedly.  Open the <code>user-model.js</code> file and find the method you want to test.  Now, add a breakpoint to this method by clicking on the line number at the left of the file window.  This will create a red dot next to that line indicating that a breakpoint has been set.  In other words, when you press the play button on the debugger, the code will run until it reaches that specific line.  Once it reaches your breakpoint line, you will be able to step into the code and determine what variables are being set, which functions are being called, etc.  Again, your <code>launch.json</code> file should look similar to this: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"node"</span>,</span><br><span class="line">    <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Mocha Tests"</span>,</span><br><span class="line">    <span class="string">"program"</span>: <span class="string">"$&#123;workspaceFolder&#125;/node_modules/mocha/bin/_mocha"</span>,</span><br><span class="line">    <span class="string">"args"</span>: [</span><br><span class="line">        <span class="string">"-u"</span>,</span><br><span class="line">        <span class="string">"tdd"</span>,</span><br><span class="line">        <span class="string">"--timeout"</span>,</span><br><span class="line">        <span class="string">"999999"</span>,</span><br><span class="line">        <span class="string">"--colors"</span>,</span><br><span class="line">        <span class="string">"$&#123;workspaceFolder&#125;/test"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"internalConsoleOptions"</span>: <span class="string">"openOnSessionStart"</span>,</span><br><span class="line">    <span class="string">"skipFiles"</span>: [</span><br><span class="line">        <span class="string">"&lt;node_internals&gt;/**/*.js"</span>,</span><br><span class="line">        <span class="string">"$&#123;workspaceFolder&#125;/node_modules/**/*.js"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you created your launch.json using the “Add Configuration…” button, you will not see the <code>skipFiles</code> line.  This is because I have manually inserted this line to prevent the debugger from debugging native NodeJS code.  The <code>&quot;&lt;node_internals&gt;/**/*.js&quot;</code> is a pattern provided by the <a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_skipping-uninteresting-code-node-chrome" target="_blank" rel="noopener">VSCode docs</a>.  The <code>&quot;${workspaceFolder}/node_modules/**/*.js&quot;</code> line tells the debugger to skip through all of the code run by the packages in your <code>node_modules/</code> directory.  In other words, it skips through the Mocha internal functions.  The net effect of all this is to allow you to focus only on <em>your</em> code.</p>
<p>You may experience that the debugger initially skips over all of your code at the beginning when you have skipped certain files.  Just keep clicking the “step into” button and you will eventually hit the code that you personally wrote.  Feel free to tweak your <code>launch.json</code> file for more custom debugging functionality.</p>
<p>Debugging is kind of like testing.  It’s one of those things that a new developer will never be excited to learn, yet it can save that same developer more time than he could ever imagine if he were to just spend a few minutes learning this critical skill.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>As mentioned, testing and debugging are two skills in the toolbox of a developer that are often overlooked and/or avoided.  Despite this, going through the pain of teaching yourself these two skills will not just enhance your effectiveness as a developer, but will transform your way of development completely.  No longer will you spend countless hours writing <code>console.log()</code> statements trying to figure out where things are going wrong.  No longer will you add a feature to your project, walk around the house all proud for a few hours, and then find that you’re going to be up late that night because that awesome feature actually broke the rest of your code, and your only debugging technique is “console.logging”.  You will instead write a feature knowing that if it breaks something else, your test suite will tell you, and furthermore, you will easily be able to debug it.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Brief-Introduction-to-SinonJS"><span class="toc-number">1.</span> <span class="toc-text">Brief Introduction to SinonJS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Preparing-your-Express-Application"><span class="toc-number">2.</span> <span class="toc-text">Preparing your Express Application</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Writing-Unit-Tests-for-Basic-functions"><span class="toc-number">3.</span> <span class="toc-text">Writing Unit Tests for Basic functions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-up-the-test-file"><span class="toc-number">3.1.</span> <span class="toc-text">Setting up the test file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-user-model-js"><span class="toc-number">3.2.</span> <span class="toc-text">Testing user-model.js</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Writing-Unit-Tests-for-Express-routes"><span class="toc-number">4.</span> <span class="toc-text">Writing Unit Tests for Express routes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-route"><span class="toc-number">4.1.</span> <span class="toc-text">Register route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-by-ID-route"><span class="toc-number">4.2.</span> <span class="toc-text">Get by ID route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authenticate-by-ID-and-password-route"><span class="toc-number">4.3.</span> <span class="toc-text">Authenticate by ID and password route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writing-the-tests"><span class="toc-number">4.4.</span> <span class="toc-text">Writing the tests</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Debugging-SinonJS-unit-tests"><span class="toc-number">5.</span> <span class="toc-text">Debugging SinonJS unit tests</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zachgoll.github.io/blog/2018/express-sinon/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zachgoll.github.io/blog/2018/express-sinon/&text=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zachgoll.github.io/blog/2018/express-sinon/&is_video=false&description=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Writing SinonJS Unit Tests for an Express Application&body=Check out this article: http://zachgoll.github.io/blog/2018/express-sinon/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zachgoll.github.io/blog/2018/express-sinon/&title=Writing SinonJS Unit Tests for an Express Application"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zachgoll.github.io/blog/2018/express-sinon/&name=Writing SinonJS Unit Tests for an Express Application&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Zach Gollwitzer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="http://zachgoll.github.io">Home</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="http://zachgoll.github.io/portfolio">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/blog/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/blog/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/blog/lib/jquery/jquery.min.js"></script>
<script src="/blog/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/blog/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-149577498-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zachgoll';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


